

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    
    <meta name="author" content="小鳥遊死月">
    
    <meta name="description" content="原題　　題目是這樣的。
123456var a = 2;function foo()&amp;#123;    console.log(this.a);&amp;#125;foo();

上題由我們親愛的小龍童鞋發現並在我們的 901 羣裏提問的。

經過　　然後有下面的小對話。

小龍：你們猜這個輸出什麼？
弍紓">
    
    

    
    <link rel="alternative" href="http://xcoder.in/atom.xml" title="艾克斯の編碼者" type="application/atom+xml">
    
    
    

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Node.js 啓動方式：一道關於全局變量的題目引發的思考 | 艾克斯の編碼者 · 一個偽宅级别的蒟蒻碼畜。</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="/css/style.css" type="text/css">

    <!-- Javascript -->
    <script src="/js/jquery-2.1.0.min.js"></script>
    <script src="/js/jquery.backstretch.min.js"></script>
    <script src="/bootstrap/js/bootstrap.min.js"></script>
    <script src="/js/headroom.min.js"></script>
    <script src="/js/jquery.headroom.min.js"></script> 
    <script src="/js/common.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-inverse" role="banner">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://xcoder.in" title="艾克斯の編碼者">艾克斯の編碼者</a>
            </div>

            <div role="navigation" class="collapse navbar-collapse bs-navbar-collapse">
                <p class="navbar-text pull-right">一個偽宅级别的蒟蒻碼畜。</p>

                <ul class="nav navbar-nav">
                    
                    <li id="nav-index"><a href="/">首页</a></li>
                    
                    <li id="nav-archives"><a href="/archives">归档</a></li>
                    
                    <li id="nav-tags"><a href="/tags">标签</a></li>
                    
                    <li id="nav-categories"><a href="/categories">分类</a></li>
                    
                    <li id="nav-curriculumvitae"><a href="/curriculumvitae">关于</a></li>
                    
                    <li id="nav-links"><a href="/links">链接</a></li>
                    
                    
                    <li><a href="https://github.com/XadillaX" target="_blank">GitHub</a></li>
                </ul>
            </div>
        </div>
    </nav>
    
    <script>
    var backRoot = "/images/background/";
    var backArray = [ "1.jpeg", "2.jpeg", "3.jpeg", "4.jpeg", "5.jpeg", "6.jpeg", "img/iPad_Photo_20140328181354FGPM.JPG", "img/iPad_Photo_20140328181218SLUY.JPG", "img/iPad_Photo_20140328181239ME9E.JPG", "img/iPad_Photo_20140328175718BF7T.JPG", "likeit/465_16170978_35afb62980c6d1a.jpg", "likeit/wallpaper-86487.jpg", "likeit/wallpaper-651939.jpg", "likeit/wallpaper-648634.jpg", "likeit/wallpaper-657798.jpg", "likeit/wallpaper-1479749.jpg", "likeit/wallpaper-1961179.jpg", "likeit/wallpaper-1947874.jpg", "likeit/wallpaper-2055407.jpg", "likeit/wallpaper-2060090.png", "likeit/wallpaper-2142870.jpg", "likeit/wallpaper-2078006.jpg", "likeit/wallpaper-2127699.jpg", "likeit/wallpaper-2211066.jpg", "likeit/wallpaper-2588686.jpg", "likeit/wallpaper-2639031.jpg", "likeit/wallpaper-2430341.jpg", "likeit/wallpaper-2294985.jpg", "likeit/wallpaper-2705897.jpg", "likeit/wallpaper-2063319.jpg", "likeit/wallpaper-2060101.jpg", "likeit/wallpaper-1970791.jpg", "img/iPad_Photo_20140328174508AZ11.JPG", "img/new/iPad_Photo_201403281903078UKK.JPG", "img/iPad_Photo_20140328175639RA5N.JPG", "img/iPad_Photo_20140328175820DYAC.JPG", "img/iPad_Photo_201403281806230195.JPG", "img/new/iPad_Photo_201403281919292STQ.JPG", "img/new/iPad_Photo_20140328190703781D.JPG", "flandre/p541758_2girls barefoot bat_wings bed blonde_hair blue_hair feet fetal_position flandre_scarlet flat_chest hat nude red_eyes ~.jpg", "flandre/p575023_blonde_hair flandre_scarlet hat horumon multiple_persona ponytail red_eyes side_ponytail touhou wings.jpg", "flandre/p569665_2girls barefoot blonde_hair blue_hair flandre_scarlet hat highres kinoko red_eyes remilia_scarlet siblings sisters to~.jpg", "flandre/p566082_blonde_hair flandre_scarlet hat mitsuki_(artist) ponytail red_eyes short_hair side_ponytail touhou wings.jpg", "flandre/p548132_2girls bat_wings blonde_hair blue_eyes blue_hair flandre_scarlet hat kaedena_akino mask moon red_eyes red_moon remili~.jpg", "flandre/p552906_flandre_scarlet gusutafu hong_meiling izayoi_sakuya koakuma patchouli_knowledge remilia_scarlet swimsuit touhou.jpg", "flandre/p551605_flandre_scarlet kona-ta touhou.jpg", "flandre/p551983_asuka_roze danmaku flandre_scarlet remilia_scarlet touhou.jpg", "likeit/465_16170978_2b89f5997bcff44.jpg", "likeit/wallpaper-616321.jpg", "likeit/wallpaper-343717.jpg", "likeit/wallpaper-1595016.jpg", "likeit/wallpaper-1952396.jpg", "likeit/wallpaper-2060096.jpg", "likeit/wallpaper-2315398.jpg", "likeit/wallpaper-2674370.jpg", "likeit/wallpaper-2838683.jpg", "likeit/wallpaper-2564028.png", "likeit/wallpaper-1382762.jpg", "likeit/wallpaper-1128042.jpg", "likeit/wallpaper-1396368.jpg", "likeit/wallpaper-1403569.png", "likeit/wallpaper-1593633.jpg", "likeit/wallpaper-1395408.jpg", "flandre/p539131_blonde_hair flandre_scarlet hat plastic_eraser red_eyes scenery short_hair solo touhou.jpg", "flandre/p555228_flandre_scarlet hong_meiling izayoi_sakuya patchouli_knowledge remilia_scarlet shomon swimsuit touhou.jpg", "flandre/p556145_book flandre_scarlet flower hairband hakurei_reimu hat hitoto hong_meiling izayoi_sakuya kirisame_marisa koakuma patc~.jpg", "flandre/p561220_arikichi_gen blonde_hair blue_eyes blue_hair braid flandre_scarlet izayoi_sakuya ponytail red_eyes remilia_scarlet sh~.jpg", "flandre/p541363_blonde_hair flandre_scarlet hat laevatein magic_circle poncho_(pixiv) red_eyes side_ponytail touhou wings.jpg",  ];
        
    $(function() {
        // page-id...
        var pageId = "2015/11/26/a-js-problem-about-global/";
        pageId = pageId.substr(0, pageId.indexOf("/"));
        if(pageId === "") pageId = "index";
        
        $("#nav-" + pageId).addClass("active");
    });
    </script>

    <article class="post container">
    <div class="well post-body first-post last-post">
        <h1>Node.js 啓動方式：一道關於全局變量的題目引發的思考</h1>
        
        <div class="time-info">
发表于:<time datetime="2015-11-26T13:51:37.000Z" itemprop="datePublished">2015年11月26日</time>，更新于:<time datetime="2016-07-12T11:26:19.000Z" itemprop="dateModified">2016年07月12日</time>，By <a href="http://xcoder.in" title="小鳥遊死月">小鳥遊死月</a>
        </div>
        
        <div class="post-body-inner">
            <div id="toc" class="toc-article well">
                <strong class="toc-title">大纲</strong>
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#原題"><span class="toc-number">1.</span> <span class="toc-text">原題</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#經過"><span class="toc-number">2.</span> <span class="toc-text">經過</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分析"><span class="toc-number">3.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#REPL_vs_文件執行"><span class="toc-number">4.</span> <span class="toc-text">REPL vs 文件執行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#全局對象的屬性"><span class="toc-number">4.1.</span> <span class="toc-text">全局對象的屬性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#repl-js"><span class="toc-number">4.2.</span> <span class="toc-text">repl.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VM"><span class="toc-number">4.3.</span> <span class="toc-text">VM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Node_REPL_啓動的沙箱"><span class="toc-number">4.4.</span> <span class="toc-text">Node REPL 啓動的沙箱</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小結"><span class="toc-number">5.</span> <span class="toc-text">小結</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#番外"><span class="toc-number">6.</span> <span class="toc-text">番外</span></a></li></ol>
            </div>
            
            <h2 id="原題">原題</h2><p>　　題目是這樣的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">2</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.a);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">foo();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>上題由我們親愛的<a href="http://f2e.souche.com/blog/author/wang-xing-long/" target="_blank" rel="external">小龍</a>童鞋發現並在我們的 901 羣裏提問的。</p>
</blockquote>
<h2 id="經過">經過</h2><p>　　然後有下面的小對話。</p>
<blockquote>
<p><strong>小龍：</strong>你們猜這個輸出什麼？</p>
<p><strong>弍紓：</strong>2</p>
<p><strong>力叔：</strong>2 啊</p>
<p><strong>死月·絲卡蕾特：</strong>2</p>
<p><strong>力叔：</strong>有什麼問題麼？</p>
<p><strong>小龍：</strong>輸出 undefind。</p>
<p><strong>死月·絲卡蕾特：</strong>你確定？</p>
<p><strong>小龍：</strong>是不是我電腦壞了</p>
<p><strong>力叔：</strong>你確定？</p>
<p><strong>弍紓：</strong>你確定？</p>
<p><strong>小龍：</strong>爲什麼我 node 文件名跑出來的是 undefined？</p>
<p><strong>鄭昱：</strong>-.- 一樣阿。undefined</p>
</blockquote>
<p>　　以上就是剛見到這個題目的時候羣裏的一個小討論。</p>
<h2 id="分析">分析</h2><p>　　後來我就覺得奇怪，既然小龍驗證過了，說明他也不是隨地大小便，無的放矢什麼的。</p>
<p>　　於是我也驗證了一下，不過由於偷懶，沒有跟他們一樣寫在文件裏面，而是直接 node 開了個 REPL 來輸入上述代碼。</p>
<blockquote>
<p><strong>結果是 2！</strong></p>
<p><strong>結果是 2！</strong></p>
<p><strong>結果是 2！</strong></p>
</blockquote>
<p>　　於是這就出現了一個很奇怪的問題。</p>
<p>　　尼瑪爲毛我是 <code>2</code> 他們倆是 <code>undefined</code> 啊！</p>
<p>　　不過馬上我就反應過來了——我們幾個的環境不同，他們是 <code>$ node foo.js</code> 而我是直接 node 開了個 REPL，所以有一定的區別。</p>
<p>　　而力叔本身就是前端大神，我估計是以 Chrome 的調試工具下爲基礎出的答案。</p>
<h2 id="REPL_vs_文件執行">REPL vs 文件執行</h2><p>　　其實上述的問題，需要解釋的問題大概就是 <code>a</code> 到底掛在哪了。</p>
<p>　　因爲細細一想，在 <code>function</code> 當中，<code>this</code> 指向的目標是 <code>global</code> 或者 <code>window</code>。</p>
<blockquote>
<p>還無法理解上面這句話的童鞋需要先補一下基礎。</p>
</blockquote>
<p>　　那麼最終需要解釋的就是 <code>a</code> 到底有沒有掛在全局變量上面。</p>
<p>　　這麼一想就有點細思恐極的味道了——如果在 node 線上運行環境裏面的源代碼文件裏面隨便 <code>var</code> 一個變量就掛到了全局變量裏面那是有多恐怖！</p>
<p>　　於是就有些釋然了。</p>
<p>　　但究竟是什麼原因導致 REPL 和文件執行方式不一樣的呢？</p>
<h3 id="全局對象的屬性">全局對象的屬性</h3><p>　　首先是弍紓找出了阮老師 ES6 系列文章中的<a href="http://es6.ruanyifeng.com/#docs/let" target="_blank" rel="external">全局對象屬性</a>一節。</p>
<blockquote>
<p>全局對象是最頂層的對象，在瀏覽器環境指的是 window 象，在 Node.js 指的是 global 對象。ES5 之中，全局對象的屬性與全局變量是等價的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.a = <span class="number">1</span>;</span><br><span class="line">a <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">a = <span class="number">2</span>;</span><br><span class="line"><span class="built_in">window</span>.a <span class="comment">// 2</span></span><br></pre></td></tr></table></figure>
<p>上面代碼中，全局對象的屬性賦值與全局變量的賦值，是同一件事。（對於Node來說，這一條只對REPL環境適用，模塊環境之中，全局變量必須顯式聲明成global對象的屬性。）</p>
</blockquote>
<p>有了阮老師的文章驗證了這個猜想，我可以放心大膽繼續看下去了。</p>
<h3 id="repl-js">repl.js</h3><p>　　知道了上文的內容之後，感覺首要查看的就是 Node.js 源碼中的 <a href="https://github.com/nodejs/node/blob/master/lib/repl.js#L513" target="_blank" rel="external">repl.js</a> 了。</p>
<p>　　先是結合了一下自己以前用自定義 REPL 的情況，一般的步驟先是獲取 REPL 的上下文，然後在上下文裏面貼上各種自己需要的東西。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> r = relp.start(<span class="string">" ➜ "</span>);</span><br><span class="line"><span class="keyword">var</span> c = r.context;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 c 裏面貼上各種上下文</span></span><br><span class="line">c.foo = bar;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>關於自定義 REPL 的一些使用方式可以參考下老雷寫的《<a href="https://cnodejs.org/topic/563735ed677332084c319d95" target="_blank" rel="external">Node.js 定製 REPL 的妙用</a>》。</p>
</blockquote>
<p>　　有了之前寫 REPL 的經驗，大致明白了 REPL 裏面有個上下文的東西，那麼在 repl.js 裏面我們也找到了類似的代碼。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">REPLServer.prototype.createContext = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> context;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.useGlobal) &#123;</span><br><span class="line">    context = global;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    context = vm.createContext();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> global) context[i] = global[i];</span><br><span class="line">    context.console = <span class="keyword">new</span> Console(<span class="keyword">this</span>.outputStream);</span><br><span class="line">    context.global = context;</span><br><span class="line">    context.global.global = context;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  context.module = <span class="built_in">module</span>;</span><br><span class="line">  context.require = <span class="built_in">require</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.lines = [];</span><br><span class="line">  <span class="keyword">this</span>.lines.level = [];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// make built-in modules available directly</span></span><br><span class="line">  <span class="comment">// (loaded lazily)</span></span><br><span class="line">  exports._builtinLibs.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(context, name, &#123;</span><br><span class="line">      get: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> lib = <span class="built_in">require</span>(name);</span><br><span class="line">        context._ = context[name] = lib;</span><br><span class="line">        <span class="keyword">return</span> lib;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// allow the creation of other globals with this name</span></span><br><span class="line">      set: <span class="function"><span class="keyword">function</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">delete</span> context[name];</span><br><span class="line">        context[name] = val;</span><br><span class="line">      &#125;,</span><br><span class="line">      configurable: <span class="literal">true</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> context;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>　　看到了關鍵字 <code>vm</code>。我們暫時先不管 <code>vm</code>，光從上面的代碼可以看出，<code>context</code> 要麼等於 <code>global</code>，要麼就是把 <code>global</code> 上面的所有東西都粘過來。</p>
<p>　　然後順帶着把必須的兩個不在 <code>global</code> 裏的兩個東西 <code>require</code> 和 <code>module</code> 給弄過來。</p>
<p>　　下面的東西就不需要那麼關心了。</p>
<h3 id="VM">VM</h3><p>　　接下去我們來講講 <code>vm</code>。</p>
<p>　　VM 是 node 中的一個內置模塊，可以在<a href="https://nodejs.org/dist/v4.2.2/docs/api/vm.html" target="_blank" rel="external">文檔</a>中看到說明和使用方法。</p>
<p>　　大致就是將代碼運行在一個沙箱之內，並且事先賦予其一些 <code>global</code> 變量。</p>
<p>　　而真正起到上述 <code>var</code> 和 <code>global</code> 區別的就是這個 <code>vm</code> 了。</p>
<p>　　<code>vm</code> 之中在根作用域（也就是最外層作用域）中使用 <code>var</code> 應該是跟在瀏覽器中一樣，會把變量粘到 <code>global</code>（瀏覽器中是 <code>window</code>）中去。</p>
<p>　　我們可以試試這樣的代碼：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> vm = <span class="built_in">require</span>(<span class="string">'vm'</span>);</span><br><span class="line"><span class="keyword">var</span> localVar = <span class="string">'initial value'</span>;</span><br><span class="line"></span><br><span class="line">vm.runInThisContext(<span class="string">'var localVar = "vm";'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'localVar: '</span>, localVar);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'global.localVar: '</span>, global.localVar);</span><br></pre></td></tr></table></figure>
<p>　　其輸出結果是：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">localVar: initial value</span><br><span class="line">global.localVar: vm</span><br></pre></td></tr></table></figure>
<p>　　如文檔中所說，<code>vm</code> 的一系列函數中跑腳本都無法對當前的局部變量進行訪問。各函數能訪問自己的 <code>global</code>，而 <code>runInThisContext</code> 的 <code>global</code> 與當前上下文的 <code>global</code> 是一樣的，所以能訪問當前的全局變量。</p>
<p>　　所以出現上述結果也是理所當然的了。</p>
<p>　　所以在 <code>vm</code> 中跑我們一開始拋出的問題，答案自然就是 <code>2</code> 了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> vm = <span class="built_in">require</span>(<span class="string">"vm"</span>);</span><br><span class="line"><span class="keyword">var</span> sandbox = &#123;</span><br><span class="line">    <span class="built_in">console</span>: <span class="built_in">console</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">vm.createContext(sandbox);</span><br><span class="line">vm.runInContext(<span class="string">"var a = 2;function foo()&#123;console.log(this.a);&#125;foo();"</span>, sandbox);</span><br></pre></td></tr></table></figure>
<h3 id="Node_REPL_啓動的沙箱">Node REPL 啓動的沙箱</h3><p>　　最後我們再只需要驗證一件事就能真相大白了。</p>
<p>　　平時我們自定義一個 <code>repl.js</code> 然後執行 <code>$ node repl.js</code> 的話是會啓動一個 REPL，而這個 REPL 會去調 <code>vm</code>，所以會出現 <code>2</code> 的答案；或者我們自己在代碼裏面寫一個 <code>vm</code> 然後跑之前的代碼，也是理所當然出現 <code>2</code>。</p>
<p>　　那麼我們就輸入 <code>$ node</code> 來進入的 REPL 跟我們之前講的 REPL 是不是同一個東西呢？</p>
<p>　　如果是的話，一切就釋然了。</p>
<p>　　首先我們進入到 Node 的入口文件——C++ 的 <code>int main()</code>。</p>
<p>　　它在 Node.js 源碼 <a href="https://github.com/nodejs/node/blob/0966ab99966b7d3fbe4d7b93797fb299595fca72/src/node_main.cc#L45" target="_blank" rel="external">src/node_main.cc</a> 之中。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">  setvbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>, _IOLBF, <span class="number">1024</span>);</span><br><span class="line">  <span class="keyword">return</span> node::Start(argc, argv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　就在主函數中執行了 <code>node::Start</code>。而這個 <code>node::Start</code> 又存在 <a href="https://github.com/nodejs/node/blob/0966ab99966b7d3fbe4d7b93797fb299595fca72/src/node.cc#L4109" target="_blank" rel="external">src/node.cc</a> 裏面。</p>
<p>　　然後在 <code>node::Start</code> 裏面又調用 <code>StartNodeInstance</code>，在這裏面是 <code>LoadEnvironment</code> 函數。</p>
<p>　　最後在 <code>LoadEnvironment</code> 中看到了幾句關鍵的語句：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Local&lt;String&gt; script_name = FIXED_ONE_BYTE_STRING(env-&gt;isolate(), <span class="string">"node.js"</span>);</span><br><span class="line">Local&lt;Value&gt; f_value = ExecuteString(env, MainSource(env), script_name);</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">Local&lt;Function&gt; f = Local&lt;Function&gt;::Cast(f_value);</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">Local&lt;Object&gt; global = env-&gt;context()-&gt;Global();</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">Local&lt;Value&gt; arg = env-&gt;process_object();</span><br><span class="line">f-&gt;Call(global, <span class="number">1</span>, &amp;arg);</span><br></pre></td></tr></table></figure>
<p>　　還有這麼一段關鍵的註釋。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Now we call 'f' with the 'process' variable that we've built up with</span></span><br><span class="line"><span class="comment">// all our bindings. Inside node.js we'll take care of assigning things to</span></span><br><span class="line"><span class="comment">// their places.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// We start the process this way in order to be more modular. Developers</span></span><br><span class="line"><span class="comment">// who do not like how 'src/node.js' setups the module system but do like</span></span><br><span class="line"><span class="comment">// Node's I/O bindings may want to replace 'f' with their own function.</span></span><br></pre></td></tr></table></figure>
<p>　　也就是說，啓動 <code>node</code> 的時候，在做了一些準備之後是開始載入執行 src 文件夾下面的 <a href="https://github.com/nodejs/node/blob/0966ab99966b7d3fbe4d7b93797fb299595fca72/src/node.js" target="_blank" rel="external">node.js</a> 文件。</p>
<p>　　在 <a href="https://github.com/nodejs/node/blob/0966ab99966b7d3fbe4d7b93797fb299595fca72/src/node.js#L92" target="_blank" rel="external">92 行</a>附近有針對 <code>$ node foo.js</code> 和 <code>$ node</code> 的判斷啓動不同的邏輯。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.argv[<span class="number">1</span>]) &#123;</span><br><span class="line">  <span class="comment">// make process.argv[1] into a full path</span></span><br><span class="line">  <span class="keyword">var</span> path = NativeModule.require(<span class="string">'path'</span>);</span><br><span class="line">  process.argv[<span class="number">1</span>] = path.resolve(process.argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> Module = NativeModule.require(<span class="string">'module'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  startup.preloadModules();</span><br><span class="line">  <span class="keyword">if</span> (global.v8debug &amp;&amp;</span><br><span class="line">      process.execArgv.some(<span class="function"><span class="keyword">function</span>(<span class="params">arg</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> arg.match(<span class="regexp">/^--debug-brk(=[0-9]*)?$/</span>);</span><br><span class="line">      &#125;)) &#123;</span><br><span class="line">    <span class="keyword">var</span> debugTimeout = +process.env.NODE_DEBUG_TIMEOUT || <span class="number">50</span>;</span><br><span class="line">    setTimeout(Module.runMain, debugTimeout);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Main entry point into most programs:</span></span><br><span class="line">    Module.runMain();</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> Module = NativeModule.require(<span class="string">'module'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process._forceRepl || NativeModule.require(<span class="string">'tty'</span>).isatty(<span class="number">0</span>)) &#123;</span><br><span class="line">    <span class="comment">// REPL</span></span><br><span class="line">    <span class="keyword">var</span> cliRepl = Module.requireRepl();</span><br><span class="line">    cliRepl.createInternalRepl(process.env, <span class="function"><span class="keyword">function</span>(<span class="params">err, repl</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　在上述節選代碼的第一個 <code>else if</code> 中，就是對 <code>$ node foo.js</code> 這種情況進行處理了，再做完各種初始化之後，使用 <code>Module.runMain();</code> 來運行入口代碼。</p>
<p>　　第二個 <code>else if</code> 裏面就是 <code>$ node</code> 這種情況了。</p>
<p>　　我們在終端中打開 <code>$ node</code> 的時候，TTY 通常是關連着的，所以 <code>require(&#39;tty&#39;).isatty(0)</code> 爲 <code>true</code>，也就是說會進到條件分支並且執行裏面的 <code>cliRepl</code> 相關代碼。</p>
<p>　　我們進入到 <a href="https://github.com/nodejs/node/blob/0966ab99966b7d3fbe4d7b93797fb299595fca72/lib/module.js#L490" target="_blank" rel="external">lib/module.js</a> 看看這個 <code>Module.requireRepl</code> 是什麼東西。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Module.requireRepl = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> Module._load(<span class="string">'internal/repl'</span>, <span class="string">'.'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　所以我們還是得轉入 <a href="https://github.com/nodejs/node/blob/0966ab99966b7d3fbe4d7b93797fb299595fca72/lib/internal/repl.js#L23" target="_blank" rel="external">lib/internal/repl.js</a> 來一探究竟。</p>
<p>　　上面在 <code>node.js</code> 裏面我們看到它執行了這個 <code>cliRepl</code> 的 <code>createInternalRepl</code> 函數，它的實現大概是這樣的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createRepl</span>(<span class="params">env, opts, cb</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  opts = opts || &#123;</span><br><span class="line">    ignoreUndefined: <span class="literal">false</span>,</span><br><span class="line">    terminal: process.stdout.isTTY,</span><br><span class="line">    useGlobal: <span class="literal">true</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  opts.replMode = &#123;</span><br><span class="line">    <span class="string">'strict'</span>: REPL.REPL_MODE_STRICT,</span><br><span class="line">    <span class="string">'sloppy'</span>: REPL.REPL_MODE_SLOPPY,</span><br><span class="line">    <span class="string">'magic'</span>: REPL.REPL_MODE_MAGIC</span><br><span class="line">  &#125;[<span class="built_in">String</span>(env.NODE_REPL_MODE).toLowerCase().trim()];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> repl = REPL.start(opts);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　轉頭一看這個 lib/internal/repl.js 頂端的模塊引入，赫然看到一句話：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> REPL = <span class="built_in">require</span>(<span class="string">'repl'</span>);</span><br></pre></td></tr></table></figure>
<p>　　真相大白。</p>
<h2 id="小結">小結</h2><p>　　最後再梳理一遍。</p>
<p>　　在於 Node.js 的 <code>vm</code> 裏面，頂級作用域下的 <code>var</code> 會把變量貼到 <code>global</code> 下面。而 REPL 使用了 <code>vm</code>。然後 <code>$ node</code> 進入的一個模式就是一個特定參數下面啓動的一個 <code>REPL</code>。</p>
<p>　　所以我們一開始提出的問題裏面在 <code>$ node foo.js</code> 模式下執行是 <code>undefined</code>，因爲不在全局變量上，但是啓用 <code>$ node</code> 這種 REPL 模式的時候得到的結果是 <code>2</code>。</p>
<h2 id="番外">番外</h2><blockquote>
<p><strong>小龍：</strong>我用 node test.js 跑出來是 <code>a: undefined</code>；那我應該怎麼修改“環境”，來讓他跑出：<code>a: 2</code> 呢？</p>
</blockquote>
<p>　　於是有了上面寫的那段代碼。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> vm = <span class="built_in">require</span>(<span class="string">"vm"</span>);</span><br><span class="line"><span class="keyword">var</span> sandbox = &#123;</span><br><span class="line">    <span class="built_in">console</span>: <span class="built_in">console</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">vm.createContext(sandbox);</span><br><span class="line">vm.runInContext(<span class="string">"var a = 2;function foo()&#123;console.log(this.a);&#125;foo();"</span>, sandbox);</span><br></pre></td></tr></table></figure>


			
            <section class="comment">
<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="/2015/11/26/a-js-problem-about-global/" data-title="Node.js 啓動方式：一道關於全局變量的題目引發的思考" data-url="http://xcoder.in/2015/11/26/a-js-problem-about-global/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"xcoder-ghost"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0]
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->
</section>
        </div>
    </div>
</article>

    <footer id="footer">
    <div id="bottom-tip">
        艾克斯の編碼者 —— <small>一個偽宅级别的蒟蒻碼畜。</small>
    </div>
        <small>该博客由 <a href="https://hexo.io/" target="_blank">Hexo</a> 强力驱动，搭载 <a href="https://github.com/XadillaX/hexadillax" target="_blank">Hexadillax</a> 主题</small><br />
        <small>&copy; 2014 小鳥遊死月</small>
    </footer>

    
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?d4417d158ec17db3ca549b508c2e5e07";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>



</body>
</html>

