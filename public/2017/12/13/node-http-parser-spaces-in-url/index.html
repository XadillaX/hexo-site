<!DOCTYPE html><html class="han-init" lang="zh-Hant"><head><meta name="author" content="æ­»æœˆÂ·åƒåœ¡è•¾ç‰¹"><meta name="description" itemprop="description" content="æœ¬æ–‡é¦–å‘äºçŸ¥ä¹ä¸“æ èš‚èšé‡‘æœä½“éªŒç§‘æŠ€ã€‚

é¦–å…ˆå£°æ˜ï¼Œæˆ‘åœ¨â€œBugâ€å­—çœ¼ä¸ŠåŠ äº†å¼•å·ï¼Œè‡ªç„¶æ˜¯ä¸ºäº†è¯´æ˜å®ƒå¹¶éä¸€ä¸ªçœŸ Bugã€‚
é—®é¢˜æŠ›å‡ºæ˜¨å¤©æœ‰ä¸ªç«¥é‹åœ¨çœ‹åå°ç›‘æ§çš„æ—¶å€™ï¼Œçªç„¶å‘ç°äº†ä¸€ä¸ªé”™è¯¯ï¼š
12345[error] 000001#0: ... upstream prematurely closed conne"><link rel="alternative" href="/atom.xml" title="è‰¾å…‹æ–¯ã®ç¼–ç è€…" type="application/atom+xml"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Node.js ä¸­é‡åˆ°å«ç©ºæ ¼ URL çš„ç¥å¥‡â€œBugâ€â€”â€”å°èŒƒå›´æ·±å…¥ HTTP åè®® Â· ä¸€ä¸ªä¼ªå®…çº§åˆ«çš„ç ç•œã€‚</title><link rel="stylesheet" type="text/css" href="/font/fantasque_sans_mono/stylesheet.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/webicons/2.0.0/webicons.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/Han/3.3.0/han.min.css"><link rel="stylesheet" type="text/css" href="/styles/screen.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/highlight.js/9.9.0/styles/gruvbox-dark.min.css"><meta name="generator" content="Hexo 5.3.0"></head><body><header><a href="/"><img class="logo" src="/images/avatar.gif" alt="è‰¾å…‹æ–¯ã®ç¼–ç è€…" title="è‰¾å…‹æ–¯ã®ç¼–ç è€…"></a><h1><a href="/" alt="è‰¾å…‹æ–¯ã®ç¼–ç è€…" title="è‰¾å…‹æ–¯ã®ç¼–ç è€…">è‰¾å…‹æ–¯ã®ç¼–ç è€…</a></h1><p>ä¸€ä¸ªä¼ªå®…çº§åˆ«çš„ç ç•œã€‚</p><nav><ul><li><a href="/" alt="é¦–é¡µ" title="é¦–é¡µ">é¦–é¡µ</a></li><li><a href="/pigeonhole" alt="å½’æ¡£" title="å½’æ¡£">å½’æ¡£</a></li><li><a href="/links" alt="é“¾æ¥" title="é“¾æ¥">é“¾æ¥</a></li><li><a href="/curriculumvitae" alt="å…³äº" title="å…³äº">å…³äº</a></li></ul><div class="xnews-icon"><a target="_blank" href="https://xcoder.in/atom.xml">&#xe621;</a><a target="_blank" href="https://github.com/XadillaX" style="position: relative; top: -2px;">&#xe735;</a><a target="_blank" href="https://www.zhihu.com/people/xadillax">&#xe63f;</a><a target="_blank" href="https://weibo.com/xadillax" style="position: relative; top: -2px;">&#xe603;</a></div></nav><div class="space"></div></header><main><article class="full"><h1>Node.js ä¸­é‡åˆ°å«ç©ºæ ¼ URL çš„ç¥å¥‡â€œBugâ€â€”â€”å°èŒƒå›´æ·±å…¥ HTTP åè®®</h1><span class="post-meta">å†™äº<time> 2017 å¹´ 12 æœˆ 13 æ—¥ 09 æ—¶ 16 åˆ†</time><br>æ›´æ–°äº<time> 2021 å¹´ 01 æœˆ 01 æ—¥ 20 æ—¶ 57 åˆ†</time></span><div class="article-toc"><strong>å¤§çº²</strong><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%8A%9B%E5%87%BA"><span class="toc-number">1.</span> <span class="toc-text">é—®é¢˜æŠ›å‡º</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E9%87%8D%E7%8E%B0"><span class="toc-number">2.</span> <span class="toc-text">å¼€å§‹é‡ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF-CURL-%E6%8C%87%E4%BB%A4"><span class="toc-number">2.1.</span> <span class="toc-text">å®¢æˆ·ç«¯ CURL æŒ‡ä»¤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E5%B0%8F-Node-js-%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.</span> <span class="toc-text">æœ€å° Node.js æºç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx"><span class="toc-number">2.3.</span> <span class="toc-text">Nginx</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Node-js-%E6%BA%90%E7%A0%81%E6%8E%92%E6%9F%A5"><span class="toc-number">3.</span> <span class="toc-text">Node.js æºç æ’æŸ¥</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#http-js-gt-http-server-js-gt-http-common-js"><span class="toc-number">3.1.</span> <span class="toc-text">http.js -&gt; _http_server.js -&gt; _http_common.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#node-http-parser-cc"><span class="toc-number">3.2.</span> <span class="toc-text">node_http_parser.cc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#http-parser"><span class="toc-number">3.3.</span> <span class="toc-text">http-parser</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTP-Request-%E6%95%B0%E6%8D%AE%E5%8C%85%E4%BD%93"><span class="toc-number">3.3.1.</span> <span class="toc-text">HTTP Request æ•°æ®åŒ…ä½“</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-number">3.3.2.</span> <span class="toc-text">æºç è§£æ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9E%E5%88%B0-node-http-parser-cc"><span class="toc-number">3.4.</span> <span class="toc-text">å›åˆ° node_http_parser.cc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9E%E5%88%B0-http-server-js"><span class="toc-number">3.5.</span> <span class="toc-text">å›åˆ° _http_server.js</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%8A%9E%E6%B3%95"><span class="toc-number">4.</span> <span class="toc-text">å¤„ç†åŠæ³•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E7%94%B3"><span class="toc-number">5.</span> <span class="toc-text">å¼•ç”³</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.1.</span> <span class="toc-text">Nginx å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RFC-2616-%E4%B8%8E-RFC-2396"><span class="toc-number">5.2.</span> <span class="toc-text">RFC 2616 ä¸ RFC 2396</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">å°ç»“</span></a></li></ol></div><blockquote>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/31966196">æœ¬æ–‡</a>é¦–å‘äºçŸ¥ä¹ä¸“æ <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/xtech">èš‚èšé‡‘æœä½“éªŒç§‘æŠ€</a>ã€‚</p>
</blockquote>
<p>é¦–å…ˆå£°æ˜ï¼Œæˆ‘åœ¨â€œBugâ€å­—çœ¼ä¸ŠåŠ äº†å¼•å·ï¼Œè‡ªç„¶æ˜¯ä¸ºäº†è¯´æ˜å®ƒå¹¶éä¸€ä¸ªçœŸ Bugã€‚</p>
<h2 id="é—®é¢˜æŠ›å‡º"><a href="#é—®é¢˜æŠ›å‡º" class="headerlink" title="é—®é¢˜æŠ›å‡º"></a>é—®é¢˜æŠ›å‡º</h2><p>æ˜¨å¤©æœ‰ä¸ªç«¥é‹åœ¨çœ‹åå°ç›‘æ§çš„æ—¶å€™ï¼Œçªç„¶å‘ç°äº†ä¸€ä¸ªé”™è¯¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[error] 000001#0: ... upstream prematurely closed connection while reading response header from upstream.</span><br><span class="line">  client: 10.10.10.10</span><br><span class="line">  server: foo.com</span><br><span class="line">  request: &quot;GET &#x2F;foo&#x2F;bar?rmicmd,begin run clean docker images job HTTP&#x2F;1.1&quot;</span><br><span class="line">  upstream: &quot;http:&#x2F;&#x2F;...&quot;</span><br></pre></td></tr></table></figure>
<p>å¤§æ¦‚æ„æ€å°±æ˜¯è¯´ï¼šä¸€å°æœåŠ¡å™¨é€šè¿‡ HTTP åè®®å»è¯·æ±‚å¦ä¸€å°æœåŠ¡å™¨çš„æ—¶å€™ï¼Œå•æ–¹é¢è¢«å¯¹æ–¹æœåŠ¡å™¨æ–­å¼€äº†è¿æ¥â€”â€”å¹¶ä¸”å¹¶æ²¡æœ‰ä»»ä½•è¿”å›ã€‚</p>
<h2 id="å¼€å§‹é‡ç°"><a href="#å¼€å§‹é‡ç°" class="headerlink" title="å¼€å§‹é‡ç°"></a>å¼€å§‹é‡ç°</h2><h3 id="å®¢æˆ·ç«¯-CURL-æŒ‡ä»¤"><a href="#å®¢æˆ·ç«¯-CURL-æŒ‡ä»¤" class="headerlink" title="å®¢æˆ·ç«¯ CURL æŒ‡ä»¤"></a>å®¢æˆ·ç«¯ CURL æŒ‡ä»¤</h3><p>å…¶å®è¿™æ¬¡è¯·æ±‚çš„ä¸€äº›çŒ«è…»å¾ˆå®¹æ˜“å°±èƒ½å‘ç°â€”â€”åœ¨ URL ä¸­æœ‰ç©ºæ ¼ã€‚æ‰€ä»¥æˆ‘ä»¬èƒ½ç®€åŒ–å‡ºä¸€æ¡æœ€ç®€å•çš„ CURL æŒ‡ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl <span class="string">&quot;http://foo/bar baz&quot;</span> -v</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong>ä¸å¸¦ä»»ä½•è½¬ä¹‰ã€‚</p>
</blockquote>
<h3 id="æœ€å°-Node-js-æºç "><a href="#æœ€å°-Node-js-æºç " class="headerlink" title="æœ€å° Node.js æºç "></a>æœ€å° Node.js æºç </h3><p>å¥½çš„ï¼Œé‚£ä¹ˆæ¥ä¸‹å»å¼€å§‹å†™ç›¸åº”çš„æœ€ç®€å•çš„ Node.js HTTP æœåŠ¡ç«¯æºç ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, resp</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;ğŸŒš&#x27;</span>);</span><br><span class="line">    resp.end(<span class="string">&#x27;hello world&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">5555</span>);</span><br></pre></td></tr></table></figure>
<p>å¤§åŠŸå‘Šæˆï¼Œå¯åŠ¨è¿™æ®µ Node.js ä»£ç ï¼Œå¼€å§‹è¯•è¯•çœ‹ä¸Šé¢çš„æŒ‡ä»¤å§ã€‚</p>
<p>å¦‚æœä½ ä¹Ÿæ­£åœ¨è·Ÿç€å°è¯•è¿™ä»¶äº‹æƒ…çš„è¯ï¼Œä½ å°±ä¼šå‘ç° Node.js çš„å‘½ä»¤è¡Œæ²¡æœ‰è¾“å‡ºä»»ä½•ä¿¡æ¯ï¼Œå°¤å…¶æ˜¯å˜²è®½çš„ <code>&#39;ğŸŒš&#39;</code>ï¼Œè€Œåœ¨ CURL çš„ç»“æœä¸­ï¼Œä½ å°†ä¼šçœ‹è§ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ curl &#39;http:&#x2F;&#x2F;127.0.0.1:5555&#x2F;d d&#39; -v</span><br><span class="line">*   Trying 127.0.0.1...</span><br><span class="line">* TCP_NODELAY set</span><br><span class="line">* Connected to 127.0.0.1 (127.0.0.1) port 5555 (#0)</span><br><span class="line">&gt; GET &#x2F;d d HTTP&#x2F;1.1</span><br><span class="line">&gt; Host: 127.0.0.1:5555</span><br><span class="line">&gt; User-Agent: curl&#x2F;7.54.0</span><br><span class="line">&gt; Accept: *&#x2F;*</span><br><span class="line">&gt;</span><br><span class="line">* Empty reply from server</span><br><span class="line">* Connection #0 to host 127.0.0.1 left intact</span><br><span class="line">curl: (52) Empty reply from server</span><br></pre></td></tr></table></figure>
<p>ç§ï¼Œ<strong>Empty reply from server</strong>ã€‚</p>
<h3 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h3><p>å‘ç°äº†é—®é¢˜ä¹‹åï¼Œå°±æœ‰å¦ä¸€ä¸ªé—®é¢˜å€¼å¾—æ€è€ƒäº†ï¼šå°± Node.js ä¼šå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Œè¿˜æ˜¯å…¶å®ƒä¸€äº› HTTP æœåŠ¡å™¨ä¹Ÿä¼šæœ‰è¿™ç§æƒ…å†µå‘¢ã€‚</p>
<p>äºæ˜¯æ‹¿å°ç™½é¼  Nginx åšäº†ä¸ªå®éªŒã€‚æˆ‘å†™äº†è¿™ä¹ˆä¸€ä¸ªé…ç½®ï¼š</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">5555</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> $uri;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥ç€ä¹Ÿæ‰§è¡Œä¸€é CURLï¼Œå¾—åˆ°äº†å¦‚ä¸‹çš„ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ curl &#39;http:&#x2F;&#x2F;127.0.0.1:5555&#x2F;d d&#39; -v</span><br><span class="line">*   Trying 127.0.0.1...</span><br><span class="line">* TCP_NODELAY set</span><br><span class="line">* Connected to 127.0.0.1 (127.0.0.1) port 5555 (#0)</span><br><span class="line">&gt; GET &#x2F;d d HTTP&#x2F;1.1</span><br><span class="line">&gt; Host: 127.0.0.1:5555</span><br><span class="line">&gt; User-Agent: curl&#x2F;7.54.0</span><br><span class="line">&gt; Accept: *&#x2F;*</span><br><span class="line">&gt;</span><br><span class="line">&lt; HTTP&#x2F;1.1 200 OK</span><br><span class="line">&lt; Server: openresty&#x2F;1.11.2.1</span><br><span class="line">&lt; Date: Tue, 12 Dec 2017 09:07:56 GMT</span><br><span class="line">&lt; Content-Type: application&#x2F;octet-stream</span><br><span class="line">&lt; Content-Length: 4</span><br><span class="line">&lt; Connection: keep-alive</span><br><span class="line">&lt;</span><br><span class="line">* Connection #0 to host xcoder.in left intact</span><br><span class="line">&#x2F;d d</span><br></pre></td></tr></table></figure>
<center><img src="word_bro.png" /><br /><small>å‰å®³äº†ï¼Œæˆ‘çš„ Nginx</small></center>

<p>äºæ˜¯ä¹ï¼Œç†æ‰€å½“ç„¶ï¼Œæˆ‘<strong>æš‚æ—¶</strong>å°†è¿™ä¸ªäº‹ä»¶å®šæ€§ä¸º Node.js çš„ä¸€ä¸ª Bugã€‚</p>
<h2 id="Node-js-æºç æ’æŸ¥"><a href="#Node-js-æºç æ’æŸ¥" class="headerlink" title="Node.js æºç æ’æŸ¥"></a>Node.js æºç æ’æŸ¥</h2><p>è®¤å®šäº†å®ƒæ˜¯ä¸ª Bug ä¹‹åï¼Œæˆ‘å°±å¼€å§‹äº†ä¸€è´¯çš„çœ‹æºç ç¯èŠ‚â€”â€”ç”±äºè¿™ä¸ª Bug çš„å¤ç°æ¡ä»¶æ¯”è¾ƒæ˜æ˜¾ï¼Œæˆ‘æš‚æ—¶å°†å…¶å®šæ€§ä¸ºâ€œNode.js HTTP æœåŠ¡ç«¯æ¨¡å—åœ¨æ¥åˆ°è¯·æ±‚åè§£æ HTTP æ•°æ®åŒ…çš„æ—¶å€™è§£æ URI æ—¶å‡ºäº†é—®é¢˜â€ã€‚</p>
<h3 id="http-js-gt-http-server-js-gt-http-common-js"><a href="#http-js-gt-http-server-js-gt-http-common-js" class="headerlink" title="http.js -&gt; _http_server.js -&gt; _http_common.js"></a>http.js -&gt; _http_server.js -&gt; _http_common.js</h3><blockquote>
<p>æºç ä»¥ <a target="_blank" rel="noopener" href="https://github.com/nodejs/node/tree/v8.9.2">Node.js 8.9.2</a> ä¸ºå‡†ã€‚</p>
</blockquote>
<p>è¿™é‡Œå…ˆé¢„ç•™ä¸€ä¸‹æˆ‘ä»¬èƒ½é©¬ä¸Šæƒ³åˆ°çš„ <strong>node_http_parser.cc</strong>ï¼Œè€Œå…ˆè®²è¿™å‡ ä¸ªæ–‡ä»¶ï¼Œæ˜¯æœ‰åŸå› çš„â€”â€”è¿™æ¶‰åŠåˆ°æœ€åçš„ä¸€ä¸ªåº”å¯¹æ–¹å¼ã€‚</p>
<p>é¦–å…ˆçœ‹çœ‹ <a target="_blank" rel="noopener" href="https://github.com/nodejs/node/blob/v8.9.2/lib/http.js#L33-L35"><strong>lib/http.js</strong></a> çš„ç›¸åº”æºç ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">const</span> server = <span class="built_in">require</span>(<span class="string">&#x27;_http_server&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; Server &#125; = server;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createServer</span>(<span class="params">requestListener</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Server(requestListener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆï¼Œé©¬ä¸Šè¿›å…¥ <strong>lib/_http_server.js</strong> çœ‹å§ã€‚</p>
<p>é¦–å…ˆæ˜¯åˆ›å»ºä¸€ä¸ª HttpParser å¹¶ç»‘ä¸Šç›‘å¬è·å–åˆ° HTTP æ•°æ®åŒ…åè§£æç»“æœçš„å›è°ƒå‡½æ•°çš„ä»£ç ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">  parsers,</span><br><span class="line">  ...</span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&#x27;_http_common&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connectionListener</span>(<span class="params">socket</span>) </span>&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> parser = parsers.alloc();</span><br><span class="line">  parser.reinitialize(HTTPParser.REQUEST);</span><br><span class="line">  parser.socket = socket;</span><br><span class="line">  socket.parser = parser;</span><br><span class="line">  parser.incoming = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  state.onData = socketOnData.bind(<span class="literal">undefined</span>, <span class="built_in">this</span>, socket, parser, state);</span><br><span class="line">  ...</span><br><span class="line">  socket.on(<span class="string">&#x27;data&#x27;</span>, state.onData);</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">socketOnData</span>(<span class="params">server, socket, parser, state, d</span>) </span>&#123;</span><br><span class="line">  assert(!socket._paused);</span><br><span class="line">  debug(<span class="string">&#x27;SERVER socketOnData %d&#x27;</span>, d.length);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> ret = parser.execute(d);</span><br><span class="line">  onParserExecuteCommon(server, socket, parser, state, ret, d);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»æºç ä¸­æ–‡æˆ‘ä»¬èƒ½çœ‹åˆ°ï¼Œå½“ä¸€ä¸ª HTTP è¯·æ±‚è¿‡æ¥çš„æ—¶å€™ï¼Œç›‘å¬å‡½æ•° <code>connectionListener()</code> ä¼šæ‹¿ç€ Socket å¯¹è±¡åŠ ä¸Šä¸€ä¸ª <code>data</code> äº‹ä»¶ç›‘å¬â€”â€”ä¸€æ—¦æœ‰è¯·æ±‚è¿æ¥è¿‡æ¥ï¼Œå°±å»æ‰§è¡Œ <code>socketOnData()</code> å‡½æ•°ã€‚</p>
<p>è€Œåœ¨ <code>socketOnData()</code> å‡½æ•°ä¸­ï¼Œåšçš„ä¸»è¦äº‹æƒ…å°±æ˜¯ <code>parser.execute(d)</code> æ¥è§£æ HTTP æ•°æ®åŒ…ï¼Œåœ¨è§£æå®Œæˆåæ‰§è¡Œä¸€ä¸‹å›è°ƒå‡½æ•° <code>onParserExecuteCommon()</code>ã€‚</p>
<p>è‡³äºè¿™ä¸ª <code>parser</code>ï¼Œæˆ‘ä»¬èƒ½çœ‹åˆ°å®ƒæ˜¯ä» <a target="_blank" rel="noopener" href="https://github.com/nodejs/node/blob/v8.9.2/lib/_http_common.js#L170-L193"><strong>lib/_http_common.js</strong></a> ä¸­æ¥çš„ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> parsers = <span class="keyword">new</span> FreeList(<span class="string">&#x27;parsers&#x27;</span>, <span class="number">1000</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> parser = <span class="keyword">new</span> HTTPParser(HTTPParser.REQUEST);</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  parser[kOnHeaders] = parserOnHeaders;</span><br><span class="line">  parser[kOnHeadersComplete] = parserOnHeadersComplete;</span><br><span class="line">  parser[kOnBody] = parserOnBody;</span><br><span class="line">  parser[kOnMessageComplete] = parserOnMessageComplete;</span><br><span class="line">  parser[kOnExecute] = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> parser;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>èƒ½çœ‹å‡ºæ¥ <code>parsers</code> æ˜¯ <code>HTTPParser</code> çš„ä¸€æ¡ Free Listï¼ˆæ•ˆæœç±»ä¼¼äºæœ€ç®€æ˜“çš„åŠ¨æ€å†…å­˜æ± ï¼‰ï¼Œæ¯ä¸ª Parser åœ¨åˆå§‹åŒ–çš„æ—¶å€™ç»‘å®šä¸Šäº†å„ç§å›è°ƒå‡½æ•°ã€‚å…·ä½“çš„ä¸€äº›å›è°ƒå‡½æ•°å°±ä¸ç»†è®²äº†ï¼Œæœ‰å…´è¶£çš„ç«¥é‹å¯è‡ªè¡Œç¿»é˜…ã€‚</p>
<p>è¿™ä¹ˆä¸€æ¥ï¼Œé“¾è·¯å°±æ¯”è¾ƒæ˜æ™°äº†ï¼š</p>
<p><strong>è¯·æ±‚è¿›æ¥çš„æ—¶å€™ï¼ŒServer å¯¹è±¡ä¼šä¸ºè¯¥æ¬¡è¯·æ±‚çš„ Socket åˆ†é…ä¸€ä¸ª <code>HttpParser</code> å¯¹è±¡ï¼Œå¹¶è°ƒç”¨å…¶ <code>execute()</code> å‡½æ•°è¿›è¡Œè§£æï¼Œåœ¨è§£æå®Œæˆåè°ƒç”¨ <code>onParserExecuteCommon()</code> å‡½æ•°ã€‚</strong></p>
<h3 id="node-http-parser-cc"><a href="#node-http-parser-cc" class="headerlink" title="node_http_parser.cc"></a>node_http_parser.cc</h3><p>æˆ‘ä»¬åœ¨ <strong>lib/_http_common.js</strong> ä¸­èƒ½å‘ç°ï¼Œ<code>HTTPParser</code> çš„å®ç°å­˜åœ¨äº <strong>src/node_http_parser.cc</strong> ä¸­ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> binding = process.binding(<span class="string">&#x27;http_parser&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; methods, HTTPParser &#125; = binding;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è‡³äºä¸ºä»€ä¹ˆ <code>const binding = process.binding(&#39;http_parser&#39;)</code> å°±æ˜¯å¯¹åº”åˆ° <strong>src/node_http_parser.cc</strong> æ–‡ä»¶ï¼Œä»¥åŠè¿™ä¸€å°èŠ‚ä¸­ä¸‹é¢çš„ä¸€äº› C++ æºç ç›¸å…³åˆ†æï¼Œä¸æ˜ç™½ä¸”æœ‰å…´è¶£çš„ç«¥é‹å¯è‡ªè¡Œå»é˜…è¯»æ›´æ·±ä¸€å±‚çš„æºç ï¼Œæˆ–è€…ç½‘ä¸Šæœç´¢ç­”æ¡ˆï¼Œæˆ–è€…æˆ‘æå‰æ— è€»ç¡¬å¹¿ä¸€ä¸‹æˆ‘å¿«è¦ä¸Šå¸‚çš„ä¹¦ã€ŠNode.jsï¼šæ¥ä¸€æ‰“ C++ æ‰©å±•ã€‹â€”â€”é‡Œé¢ä¹Ÿæœ‰è¯´æ˜ï¼Œä»¥åŠæˆ‘çš„æœ‰ä¸€åœºçŸ¥ä¹ Liveã€Šæ·±å…¥ç†è§£ Node.js åŒ…ä¸æ¨¡å—æœºåˆ¶ã€‹ã€‚</p>
</blockquote>
<p>æ€»è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬æ¥ä¸‹å»è¦çœ‹çš„å°±æ˜¯ <a target="_blank" rel="noopener" href="https://github.com/nodejs/node/blob/v8.9.2/src/node_http_parser.cc#L796-L804"><strong>src/node_http_parser.cc</strong></a> äº†ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">env-&gt;SetProtoMethod(t, <span class="string">&quot;close&quot;</span>, Parser::Close);</span><br><span class="line">env-&gt;SetProtoMethod(t, <span class="string">&quot;execute&quot;</span>, Parser::Execute);</span><br><span class="line">env-&gt;SetProtoMethod(t, <span class="string">&quot;finish&quot;</span>, Parser::Finish);</span><br><span class="line">env-&gt;SetProtoMethod(t, <span class="string">&quot;reinitialize&quot;</span>, Parser::Reinitialize);</span><br><span class="line">env-&gt;SetProtoMethod(t, <span class="string">&quot;pause&quot;</span>, Parser::Pause&lt;<span class="literal">true</span>&gt;);</span><br><span class="line">env-&gt;SetProtoMethod(t, <span class="string">&quot;resume&quot;</span>, Parser::Pause&lt;<span class="literal">false</span>&gt;);</span><br><span class="line">env-&gt;SetProtoMethod(t, <span class="string">&quot;consume&quot;</span>, Parser::Consume);</span><br><span class="line">env-&gt;SetProtoMethod(t, <span class="string">&quot;unconsume&quot;</span>, Parser::Unconsume);</span><br><span class="line">env-&gt;SetProtoMethod(t, <span class="string">&quot;getCurrentBuffer&quot;</span>, Parser::GetCurrentBuffer);</span><br></pre></td></tr></table></figure>
<p>å¦‚ä»£ç ç‰‡æ®µæ‰€ç¤ºï¼Œå‰æ–‡ä¸­ <code>parser.execute()</code> æ‰€å¯¹åº”çš„å‡½æ•°å°±æ˜¯ <code>Parser::Execute()</code> äº†ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Parser</span> :</span> <span class="keyword">public</span> AsyncWrap &#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Execute</span><span class="params">(<span class="keyword">const</span> FunctionCallbackInfo&lt;Value&gt;&amp; args)</span> </span>&#123;</span><br><span class="line">    Parser* parser;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    Local&lt;Object&gt; buffer_obj = args[<span class="number">0</span>].As&lt;Object&gt;();</span><br><span class="line">    <span class="keyword">char</span>* buffer_data = Buffer::Data(buffer_obj);</span><br><span class="line">    <span class="keyword">size_t</span> buffer_len = Buffer::Length(buffer_obj);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    Local&lt;Value&gt; ret = parser-&gt;Execute(buffer_data, buffer_len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ret.IsEmpty())</span><br><span class="line">      args.GetReturnValue().Set(ret);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">Local&lt;Value&gt; <span class="title">Execute</span><span class="params">(<span class="keyword">char</span>* data, <span class="keyword">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="function">EscapableHandleScope <span class="title">scope</span><span class="params">(env()-&gt;isolate())</span></span>;</span><br><span class="line"></span><br><span class="line">    current_buffer_len_ = len;</span><br><span class="line">    current_buffer_data_ = data;</span><br><span class="line">    got_exception_ = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> nparsed =</span><br><span class="line">      http_parser_execute(&amp;parser_, &amp;settings, data, len);</span><br><span class="line"></span><br><span class="line">    Save();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Unassign the &#x27;buffer_&#x27; variable</span></span><br><span class="line">    current_buffer_.Clear();</span><br><span class="line">    current_buffer_len_ = <span class="number">0</span>;</span><br><span class="line">    current_buffer_data_ = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If there was an exception in one of the callbacks</span></span><br><span class="line">    <span class="keyword">if</span> (got_exception_)</span><br><span class="line">      <span class="keyword">return</span> scope.Escape(Local&lt;Value&gt;());</span><br><span class="line"></span><br><span class="line">    Local&lt;Integer&gt; nparsed_obj = Integer::New(env()-&gt;isolate(), nparsed);</span><br><span class="line">    <span class="comment">// If there was a parse error in one of the callbacks</span></span><br><span class="line">    <span class="comment">// TODO(bnoordhuis) What if there is an error on EOF?</span></span><br><span class="line">    <span class="keyword">if</span> (!parser_.upgrade &amp;&amp; nparsed != len) &#123;</span><br><span class="line">      <span class="class"><span class="keyword">enum</span> <span class="title">http_errno</span> <span class="title">err</span> =</span> HTTP_PARSER_ERRNO(&amp;parser_);</span><br><span class="line"></span><br><span class="line">      Local&lt;Value&gt; e = Exception::Error(env()-&gt;parse_error_string());</span><br><span class="line">      Local&lt;Object&gt; obj = e-&gt;ToObject(env()-&gt;isolate());</span><br><span class="line">      obj-&gt;Set(env()-&gt;bytes_parsed_string(), nparsed_obj);</span><br><span class="line">      obj-&gt;Set(env()-&gt;code_string(),</span><br><span class="line">               OneByteString(env()-&gt;isolate(), http_errno_name(err)));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> scope.Escape(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> scope.Escape(nparsed_obj);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆè¿›å…¥ <code>Parser</code> çš„é™æ€ <code>Execute()</code> å‡½æ•°ï¼Œæˆ‘ä»¬çœ‹åˆ°å®ƒæŠŠä¼ è¿›æ¥çš„ <code>Buffer</code> è½¬åŒ–ä¸º C++ ä¸‹çš„ <code>char*</code> æŒ‡é’ˆï¼Œå¹¶è®°å½•å…¶æ•°æ®é•¿åº¦ï¼ŒåŒæ—¶å»æ‰§è¡Œå½“å‰è°ƒç”¨çš„ <code>parser</code> å¯¹è±¡æ‰€å¯¹åº”çš„ <code>Execute()</code> å‡½æ•°ã€‚</p>
<p>åœ¨è¿™ä¸ª <code>Execute()</code> å‡½æ•°ä¸­ï¼Œæœ‰ä¸ªæœ€é‡è¦çš„ä»£ç ï¼Œå°±æ˜¯ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> nparsed =</span><br><span class="line">    http_parser_execute(&amp;parser_, &amp;settings, data, len);</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç æ˜¯è°ƒç”¨çœŸæ­£è§£æ HTTP æ•°æ®åŒ…çš„å‡½æ•°ï¼Œå®ƒæ˜¯ Node.js è¿™ä¸ªé¡¹ç›®çš„ä¸€ä¸ªè‡ªç ”ä¾èµ–ï¼Œå« <a target="_blank" rel="noopener" href="https://github.com/nodejs/node/tree/v8.9.2/deps/http_parser">http-parser</a>ã€‚å®ƒç‹¬ç«‹çš„é¡¹ç›®åœ°å€åœ¨ <a target="_blank" rel="noopener" href="https://github.com/nodejs/http-parser">https://github.com/nodejs/http-parser</a>ï¼Œæˆ‘ä»¬æœ¬æ–‡ä¸­ç”¨çš„æ˜¯ Node.js v8.9.2 ä¸­æ‰€ä¾èµ–çš„æºç ï¼Œåº”è¯¥ä¼šæœ‰åå·®ã€‚</p>
<h3 id="http-parser"><a href="#http-parser" class="headerlink" title="http-parser"></a>http-parser</h3><h4 id="HTTP-Request-æ•°æ®åŒ…ä½“"><a href="#HTTP-Request-æ•°æ®åŒ…ä½“" class="headerlink" title="HTTP Request æ•°æ®åŒ…ä½“"></a>HTTP Request æ•°æ®åŒ…ä½“</h4><blockquote>
<p>å¦‚æœä½ å·²ç»å¯¹ HTTP åŒ…ä½“äº†è§£äº†ï¼Œå¯ä»¥ç•¥è¿‡è¿™ä¸€èŠ‚ã€‚</p>
</blockquote>
<p>HTTP çš„ Request æ•°æ®åŒ…å…¶å®æ˜¯æ–‡æœ¬æ ¼å¼çš„ï¼Œåœ¨ Raw çš„çŠ¶æ€ä¸‹ï¼Œå¤§æ¦‚æ˜¯ä»¥è¿™æ ·çš„å½¢å¼å­˜åœ¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æ–¹æ³• URI HTTP&#x2F;ç‰ˆæœ¬</span><br><span class="line">å¤´1: æˆ‘æ˜¯å¤´1</span><br><span class="line">å¤´2: æˆ‘æ˜¯å¤´2</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ç®€å•èµ·è§ï¼Œè¿™é‡Œå°±å†™å‡ºæœ€åŸºç¡€çš„ä¸€äº›å†…å®¹ï¼Œè‡³äº Body ä»€ä¹ˆçš„å¤§å®¶è‡ªå·±æ‰¾èµ„æ–™çœ‹å§ã€‚</p>
</blockquote>
<p>ä¸Šé¢çš„æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿæˆ‘ä»¬çœ‹çœ‹ CURL çš„ç»“æœå°±çŸ¥é“äº†ï¼Œå®é™…ä¸Šå¯¹åº” <code>curl ... -v</code> çš„ä¸­é—´è¾“å‡ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;test HTTP&#x2F;1.1</span><br><span class="line">Host: 127.0.0.1:5555</span><br><span class="line">User-Agent: curl&#x2F;7.54.0</span><br><span class="line">Accept: *&#x2F;*</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥å®é™…ä¸Šå¤§å®¶å¹³æ—¶åœ¨æ–‡ç« ä¸­ã€æµè§ˆå™¨è°ƒè¯•å·¥å…·ä¸­çœ‹åˆ°çš„ä»€ä¹ˆè¯·æ±‚å¤´å•Šä»€ä¹ˆçš„ï¼Œéƒ½æ˜¯ä»¥æ–‡æœ¬å½¢å¼å­˜åœ¨çš„ï¼Œä»¥æ¢è¡Œç¬¦åˆ†å‰²ã€‚</p>
<p>è€Œâ€”â€”é‡ç‚¹æ¥äº†ï¼Œå¯¼è‡´æˆ‘ä»¬æœ¬æ–‡æ‰€è¿°â€œBugâ€å‡ºç°çš„è¯·æ±‚ï¼Œå®ƒçš„è¯·æ±‚åŒ…å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;foo bar HTTP&#x2F;1.1</span><br><span class="line">Host: 127.0.0.1:5555</span><br><span class="line">User-Agent: curl&#x2F;7.54.0</span><br><span class="line">Accept: *&#x2F;*</span><br></pre></td></tr></table></figure>
<p>é‡ç‚¹åœ¨ç¬¬ä¸€è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;foo bar HTTP&#x2F;1.1</span><br></pre></td></tr></table></figure>
<h4 id="æºç è§£æ"><a href="#æºç è§£æ" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h4><p>è¯ä¸å¤šå°‘ï¼Œæˆ‘ä»¬ä¹‹é—´å‰å¾€ http-parser çš„ <a target="_blank" rel="noopener" href="https://github.com/nodejs/node/blob/v8.9.2/deps/http_parser/http_parser.c#L634">http_parser.c</a> çœ‹ <code>http_parser_execute ()</code> å‡½æ•°ä¸­çš„çŠ¶æ€æœºå˜åŒ–ã€‚</p>
<p>ä»æºç ä¸­æ–‡æˆ‘ä»¬èƒ½çœ‹åˆ°ï¼Œhttp-parser çš„æµç¨‹æ˜¯ä»å¤´åˆ°å°¾ä»¥ O(n) çš„æ—¶é—´å¤æ‚åº¦å¯¹å­—ç¬¦ä¸²é€å­—æ‰«æï¼Œå¹¶ä¸”ä¸åé€€ä¹Ÿä¸å¾€å‰è·³ã€‚</p>
<p>é‚£ä¹ˆæ‰«æåˆ°æ¯ä¸ªå­—ç¬¦çš„æ—¶å€™ï¼Œéƒ½æœ‰å±äºå½“å‰çš„ä¸€ä¸ªçŠ¶æ€ï¼Œå¦‚â€œæ­£åœ¨æ‰«æå¤„ç† uriâ€ã€â€œæ­£åœ¨æ‰«æå¤„ç† HTTP åè®®å¹¶ä¸”å¤„ç†åˆ°äº† Hâ€ã€â€œæ­£åœ¨æ‰«æå¤„ç† HTTP åè®®å¹¶ä¸”å¤„ç†åˆ°äº† HTâ€ã€â€œæ­£åœ¨æ‰«æå¤„ç† HTTP åè®®å¹¶ä¸”å¤„ç†åˆ°äº† HTTâ€ã€â€œæ­£åœ¨æ‰«æå¤„ç† HTTP åè®®å¹¶ä¸”å¤„ç†åˆ°äº† HTTPâ€ã€â€¦â€¦</p>
<center><img src="baoqingtian.png" /></center>

<p>æ†‹ç¬‘ï¼Œè¿™æ˜¯çœŸçš„ï¼Œæˆ‘ä»¬çœ‹çœ‹ä»£ç å°±çŸ¥é“äº†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> s_req_server:</span><br><span class="line"><span class="keyword">case</span> s_req_server_with_at:</span><br><span class="line"><span class="keyword">case</span> s_req_path:</span><br><span class="line"><span class="keyword">case</span> s_req_query_string_start:</span><br><span class="line"><span class="keyword">case</span> s_req_query_string:</span><br><span class="line"><span class="keyword">case</span> s_req_fragment_start:</span><br><span class="line"><span class="keyword">case</span> s_req_fragment:</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27; &#x27;</span>:</span><br><span class="line">      UPDATE_STATE(s_req_http_start);</span><br><span class="line">      CALLBACK_DATA(url);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> CR:</span><br><span class="line">    <span class="keyword">case</span> LF:</span><br><span class="line">      parser-&gt;http_major = <span class="number">0</span>;</span><br><span class="line">      parser-&gt;http_minor = <span class="number">9</span>;</span><br><span class="line">      UPDATE_STATE((ch == CR) ?</span><br><span class="line">        s_req_line_almost_done :</span><br><span class="line">        s_header_field_start);</span><br><span class="line">      CALLBACK_DATA(url);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      UPDATE_STATE(parse_url_char(CURRENT_STATE(), ch));</span><br><span class="line">      <span class="keyword">if</span> (UNLIKELY(CURRENT_STATE() == s_dead)) &#123;</span><br><span class="line">        SET_ERRNO(HPE_INVALID_URL);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨æ‰«æçš„æ—¶å€™ï¼Œå¦‚æœå½“å‰çŠ¶æ€æ˜¯ URI ç›¸å…³çš„ï¼ˆå¦‚ <code>s_req_path</code>ã€<code>s_req_query_string</code> ç­‰ï¼‰ï¼Œåˆ™æ‰§è¡Œä¸€ä¸ªå­ <code>switch</code>ï¼Œé‡Œé¢çš„å¤„ç†å¦‚ä¸‹ï¼š</p>
<ul>
<li>è‹¥å½“å‰å­—ç¬¦æ˜¯ç©ºæ ¼ï¼Œåˆ™å°†çŠ¶æ€æ”¹å˜ä¸º <code>s_req_http_start</code> å¹¶è®¤ä¸º URI å·²ç»è§£æå¥½äº†ï¼Œé€šè¿‡å® <code>CALLBACK_DATA()</code> è§¦å‘ URI è§£æå¥½çš„äº‹ä»¶ï¼›</li>
<li>è‹¥å½“å‰å­—ç¬¦æ˜¯æ¢è¡Œç¬¦ï¼Œåˆ™è¯´æ˜è¿˜åœ¨è§£æ URI çš„æ—¶å€™å°±è¢«æ¢è¡Œäº†ï¼Œåé¢å°±ä¸å¯èƒ½è·Ÿç€ HTTP åè®®ç‰ˆæœ¬çš„ç”³æ˜äº†ï¼Œæ‰€ä»¥è®¾ç½®é»˜è®¤çš„ HTTP ç‰ˆæœ¬ä¸º <code>0.9</code>ï¼Œå¹¶ä¿®æ”¹å½“å‰çŠ¶æ€ï¼Œæœ€åè®¤ä¸º URI å·²ç»è§£æå¥½äº†ï¼Œé€šè¿‡å® <code>CALLBACK_DATA()</code> è§¦å‘ URI è§£æå¥½çš„äº‹ä»¶ï¼›</li>
<li>å…¶ä½™æƒ…å†µï¼ˆæ‰€æœ‰å…¶å®ƒå­—ç¬¦ï¼‰ä¸‹ï¼Œé€šè¿‡è°ƒç”¨ <code>parse_url_char()</code> å‡½æ•°æ¥è§£æä¸€äº›ä¸œè¥¿å¹¶æ›´æ–°å½“å‰çŠ¶æ€ã€‚ï¼ˆå› ä¸ºå“ªæ€•æ˜¯åœ¨è§£æ URI çŠ¶æ€ä¸­ï¼Œä¹Ÿè¿˜æœ‰å„ç§ä¸åŒçš„ç»†åˆ†ï¼Œå¦‚ <code>s_req_path</code>ã€<code>s_req_query_string</code> ï¼‰</li>
</ul>
<p>è¿™é‡Œçš„é‡ç‚¹è¿˜æ˜¯å½“çŠ¶æ€ä¸ºè§£æ URI çš„æ—¶å€™é‡åˆ°äº†ç©ºæ ¼çš„å¤„ç†ï¼Œä¸Šé¢ä¹Ÿè§£é‡Šè¿‡äº†ï¼Œä¸€æ—¦é‡åˆ°è¿™ç§æƒ…å†µï¼Œåˆ™ä¼šè®¤ä¸º URI å·²ç»è§£æå¥½äº†ï¼Œå¹¶ä¸”å°†çŠ¶æ€ä¿®æ”¹ä¸º <code>s_req_http_start</code>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæœ‰â€œBugâ€çš„é‚£ä¸ªæ•°æ®åŒ…<br> <code>GET /foo bar HTTP/1.1</code> åœ¨è§£æåˆ° <code>foo</code> åé¢çš„ç©ºæ ¼çš„æ—¶å€™å®ƒå°±å°†çŠ¶æ€æ”¹ä¸º <code>s_req_http_start</code> å¹¶ä¸”è®¤ä¸º URI å·²ç»è§£æç»“æŸäº†ã€‚</p>
<p>å¥½çš„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ <code>s_req_http_start</code> æ€ä¹ˆå¤„ç†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> s_req_http_start:</span><br><span class="line">  <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;H&#x27;</span>:</span><br><span class="line">      UPDATE_STATE(s_req_http_H);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27; &#x27;</span>:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      SET_ERRNO(HPE_INVALID_CONSTANT);</span><br><span class="line">      <span class="keyword">goto</span> error;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> s_req_http_H:</span><br><span class="line">  STRICT_CHECK(ch != <span class="string">&#x27;T&#x27;</span>);</span><br><span class="line">  UPDATE_STATE(s_req_http_HT);</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> s_req_http_HT:</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> s_req_http_HTT:</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> s_req_http_HTTP:</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> s_req_first_http_major:</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<p>å¦‚ä»£ç æ‰€è§ï¼Œè‹¥å½“å‰çŠ¶æ€ä¸º <code>s_req_http_start</code>ï¼Œåˆ™å…ˆåˆ¤æ–­å½“å‰å­—ç¬¦æ˜¯ä¸æ˜¯åˆæ ‡ã€‚å› ä¸ºå°± HTTP è¯·æ±‚åŒ…ä½“çš„æ ¼å¼æ¥çœ‹ï¼Œå¦‚æœ URI è§£æç»“æŸçš„è¯ï¼Œç†åº”å‡ºç°ç±»ä¼¼ <code>HTTP/1.1</code> çš„è¿™ä¹ˆä¸€ä¸ªç‰ˆæœ¬ç”³æ˜ã€‚æ‰€ä»¥è¿™ä¸ªæ—¶å€™ http-parser ä¼šç›´æ¥åˆ¤æ–­å½“å‰å­—ç¬¦æ˜¯å¦ä¸º <code>H</code>ã€‚</p>
<ul>
<li>è‹¥æ˜¯ <code>H</code>ï¼Œåˆ™å°†çŠ¶æ€æ”¹ä¸º <code>s_req_http_H</code> å¹¶ç»§ç»­æ‰«æå¾ªç¯çš„ä¸‹ä¸€ä½ï¼ŒåŒç†åœ¨ <code>s_req_http_H</code> ä¸‹è‹¥åˆæ³•çŠ¶æ€å°±ä¼šå˜æˆ <code>s_req_http_HT</code>ï¼Œä»¥æ­¤ç±»æ¨ï¼›</li>
<li>è‹¥æ˜¯ç©ºæ ¼ï¼Œåˆ™è®¤ä¸ºæ˜¯å¤šä½™çš„ç©ºæ ¼ï¼Œé‚£ä¹ˆå½“å‰çŠ¶æ€ä¸åšä»»ä½•æ”¹å˜ï¼Œå¹¶ç»§ç»­ä¸‹ä¸€ä¸ªæ‰«æï¼›</li>
<li>ä½†å¦‚æœå½“å‰å­—ç¬¦æ—¢ä¸æ˜¯ç©ºæ ¼ä¹Ÿä¸æ˜¯ <code>H</code>ï¼Œé‚£ä¹ˆå¥½äº†ï¼Œhttp-parser ç›´æ¥è®¤ä¸ºä½ çš„è¯·æ±‚åŒ…ä¸åˆæ³•ï¼Œå°†ä½ æœ¬æ¬¡çš„è§£æè®¾ç½®é”™è¯¯ <code>HPE_INVALID_CONSTANT</code> å¹¶ <code>goto</code> åˆ° <code>error</code> ä»£ç å—ã€‚</li>
</ul>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬åŸºæœ¬ä¸Šå·²ç»æ˜ç™½äº†åŸå› äº†ï¼š</p>
<p><strong>http-parser è®¤ä¸ºåœ¨ HTTP è¯·æ±‚åŒ…ä½“ä¸­ï¼Œç¬¬ä¸€è¡Œçš„ URI è§£æé˜¶æ®µä¸€æ—¦å‡ºç°äº†ç©ºæ ¼ï¼Œå°±ä¼šè®¤ä¸º URI è§£æå®Œæˆï¼Œç»§è€Œè§£æ HTTP åè®®ç‰ˆæœ¬ã€‚ä½†è‹¥æ­¤æ—¶ç´§è·Ÿç€çš„ä¸æ˜¯ HTTP åè®®ç‰ˆæœ¬çš„æ ‡å‡†æ ¼å¼ï¼Œhttp-parser å°±ä¼šè®¤ä¸ºä½ è¿™æ˜¯ä¸€ä¸ª <code>HPE_INVALID_CONSTANT</code> çš„æ•°æ®åŒ…ã€‚</strong></p>
<p>ä¸è¿‡ï¼Œæˆ‘ä»¬è¿˜æ˜¯ç»§ç»­çœ‹çœ‹å®ƒçš„ <code>error</code> ä»£ç å—å§ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">error:</span><br><span class="line">  <span class="keyword">if</span> (HTTP_PARSER_ERRNO(parser) == HPE_OK) &#123;</span><br><span class="line">    SET_ERRNO(HPE_UNKNOWN);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  RETURN(p - data);</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç ä¸­é¦–å…ˆåˆ¤æ–­ä¸€ä¸‹å½“è·³åˆ°è¿™æ®µä»£ç çš„æ—¶å€™æœ‰æ²¡æœ‰è®¾ç½®é”™è¯¯ï¼Œè‹¥æ²¡æœ‰è®¾ç½®é”™è¯¯åˆ™å°†é”™è¯¯è®¾ç½®ä¸ºæœªçŸ¥é”™è¯¯ï¼ˆ<code>HPE_UNKNOWN</code>ï¼‰ï¼Œç„¶åè¿”å›å·²è§£æçš„æ•°æ®åŒ…é•¿åº¦ã€‚</p>
<blockquote>
<p><code>p</code> æ˜¯å½“å‰è§£æå­—ç¬¦æŒ‡é’ˆï¼Œ<code>data</code> æ˜¯è¿™ä¸ªæ•°æ®åŒ…çš„èµ·å§‹æŒ‡é’ˆï¼Œæ‰€ä»¥ <code>p - data</code> å°±æ˜¯å·²è§£æçš„æ•°æ®é•¿åº¦ã€‚å¦‚æœæˆåŠŸè§£æå®Œï¼Œè¿™ä¸ªæ•°æ®åŒ…ç†è®ºä¸Šæ˜¯ç­‰äºè¿™ä¸ªæ•°æ®åŒ…çš„å®Œæ•´é•¿åº¦ï¼Œè‹¥ä¸ç­‰åˆ™ç†è®ºä¸Šè¯´æ˜è‚¯å®šæ˜¯ä¸­é€”å‡ºé”™æå‰è¿”å›ã€‚</p>
</blockquote>
<h3 id="å›åˆ°-node-http-parser-cc"><a href="#å›åˆ°-node-http-parser-cc" class="headerlink" title="å›åˆ° node_http_parser.cc"></a>å›åˆ° node_http_parser.cc</h3><p>çœ‹å®Œäº† http-parser çš„åŸç†åï¼Œå¾ˆå¤šåœ°æ–¹èŒ…å¡é¡¿å¼€ã€‚ç°åœ¨æˆ‘ä»¬å›åˆ°å®ƒçš„è°ƒç”¨åœ° <a target="_blank" rel="noopener" href="https://github.com/nodejs/node/blob/v8.9.2/src/node_http_parser.cc#L630-L666"><strong>node_http_parser.cc</strong></a> ç»§ç»­é˜…è¯»å§ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Local&lt;Value&gt; <span class="title">Execute</span><span class="params">(<span class="keyword">char</span>* data, <span class="keyword">size_t</span> len)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">size_t</span> nparsed =</span><br><span class="line">    http_parser_execute(&amp;parser_, &amp;settings, data, len);</span><br><span class="line"></span><br><span class="line">  Local&lt;Integer&gt; nparsed_obj = Integer::New(env()-&gt;isolate(), nparsed);</span><br><span class="line">  <span class="keyword">if</span> (!parser_.upgrade &amp;&amp; nparsed != len) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">http_errno</span> <span class="title">err</span> =</span> HTTP_PARSER_ERRNO(&amp;parser_);</span><br><span class="line"></span><br><span class="line">    Local&lt;Value&gt; e = Exception::Error(env()-&gt;parse_error_string());</span><br><span class="line">    Local&lt;Object&gt; obj = e-&gt;ToObject(env()-&gt;isolate());</span><br><span class="line">    obj-&gt;Set(env()-&gt;bytes_parsed_string(), nparsed_obj);</span><br><span class="line">    obj-&gt;Set(env()-&gt;code_string(),</span><br><span class="line">             OneByteString(env()-&gt;isolate(), http_errno_name(err)));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> scope.Escape(e);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> scope.Escape(nparsed_obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»è°ƒç”¨å¤„æˆ‘ä»¬èƒ½çœ‹è§ï¼Œåœ¨æ‰§è¡Œå®Œ <code>http_parser_execute()</code> åæœ‰ä¸€ä¸ªåˆ¤æ–­ï¼Œè‹¥å½“å‰è¯·æ±‚ä¸æ˜¯ <code>upgrade</code> è¯·æ±‚ï¼ˆå³è¯·æ±‚å¤´ä¸­æœ‰è¯´æ˜ <code>Upgrade</code>ï¼Œé€šå¸¸ç”¨äº WebSocketï¼‰ï¼Œå¹¶ä¸”è§£æé•¿åº¦ä¸ç­‰äºåŸæ•°æ®åŒ…é•¿åº¦ï¼ˆå‰æ–‡è¯´äº†è¿™ç§æƒ…å†µå±äºå‡ºé”™äº†ï¼‰çš„è¯ï¼Œé‚£ä¹ˆè¿›å…¥ä¸­é—´çš„é”™è¯¯ä»£ç å—ã€‚</p>
<p>åœ¨é”™è¯¯ä»£ç å—ä¸­ï¼Œå…ˆ <code>HTTP_PARSER_ERRNO(&amp;parser_)</code> æ‹¿åˆ°é”™è¯¯ç ï¼Œç„¶åé€šè¿‡ <code>Exception::Error()</code> ç”Ÿæˆé”™è¯¯å¯¹è±¡ï¼Œå°†é”™è¯¯ä¿¡æ¯å¡è¿›é”™è¯¯å¯¹è±¡ä¸­ï¼Œæœ€åè¿”å›é”™è¯¯å¯¹è±¡ã€‚</p>
<p>å¦‚æœæ²¡é”™ï¼Œåˆ™è¿”å›è§£æé•¿åº¦ï¼ˆ<code>nparsed_obj</code> å³ <code>nparsed</code>ï¼‰ã€‚</p>
<blockquote>
<p>åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œçœ¼å°–çš„ç«¥é‹å¯èƒ½å‘ç°äº†ï¼Œæ‰§è¡Œ <code>Execute()</code> æœ‰å¥½å¤šå¤„ï¼Œè¿™æ˜¯å› ä¸ºå®é™…ä¸Šä¸€ä¸ª HTTP è¯·æ±‚å¯èƒ½æ˜¯æµå¼çš„ï¼Œæ‰€ä»¥æœ‰æ—¶å€™å¯èƒ½ä¼šåªæ‹¿åˆ°éƒ¨åˆ†æ•°æ®åŒ…ã€‚æ‰€ä»¥æœ€åæœ‰ä¸€ä¸ªç»“æŸç¬¦éœ€è¦è¢«ç¡®è®¤ã€‚<strong>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ http-parser åœ¨è§£æçš„æ—¶å€™åªèƒ½é€å­—è§£æè€Œä¸èƒ½è·³è·ƒæˆ–è€…åé€€äº†ã€‚</strong></p>
</blockquote>
<h3 id="å›åˆ°-http-server-js"><a href="#å›åˆ°-http-server-js" class="headerlink" title="å›åˆ° _http_server.js"></a>å›åˆ° _http_server.js</h3><p>æˆ‘ä»¬æŠŠ <code>Parser::Execute()</code> ä¹Ÿå°±æ˜¯ JavaScript ä»£ç ä¸­çš„ <code>parser.execute()</code> ç»™ææ¸…æ¥šåï¼Œæˆ‘ä»¬å°±èƒ½å›åˆ° <a target="_blank" rel="noopener" href="https://github.com/nodejs/node/blob/v8.9.2/lib/_http_server.js#L462-L507">_http_server.js</a> çœ‹ä»£ç äº†ã€‚</p>
<p>å‰æ–‡è¯´äº†ï¼Œ<code>socketOnData</code> åœ¨è§£æå®Œæ•°æ®åŒ…åä¼šæ‰§è¡Œ <code>onParserExecuteCommon</code> å‡½æ•°ï¼Œç°åœ¨å°±æ¥çœ‹çœ‹è¿™ä¸ª <code>onParserExecuteCommon()</code> å‡½æ•°ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onParserExecuteCommon</span>(<span class="params">server, socket, parser, state, ret, d</span>) </span>&#123;</span><br><span class="line">  resetSocketTimeout(server, socket, state);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ret <span class="keyword">instanceof</span> <span class="built_in">Error</span>) &#123;</span><br><span class="line">    debug(<span class="string">&#x27;parse error&#x27;</span>, ret);</span><br><span class="line">    socketOnError.call(socket, ret);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parser.incoming &amp;&amp; parser.incoming.upgrade) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é•¿é•¿çš„ä¸€ä¸ªå‡½æ•°è¢«æˆ‘ç²¾ç®€æˆè¿™ä¹ˆå‡ å¥è¯ï¼Œé‡ç‚¹å¾ˆæ˜æ˜¾ã€‚<code>ret</code> å°±æ˜¯ä» <code>socketOnData</code> ä¼ è¿›æ¥å·²è§£æçš„æ•°æ®é•¿åº¦ï¼Œä½†æ˜¯åœ¨ C++ ä»£ç ä¸­æˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†å®ƒè¿˜æœ‰å¯èƒ½æ˜¯ä¸€ä¸ªé”™è¯¯å¯¹è±¡ã€‚æ‰€ä»¥åœ¨è¿™ä¸ªå‡½æ•°ä¸­ä¸€å¼€å§‹å°±åšäº†ä¸€ä¸ªåˆ¤æ–­ï¼Œåˆ¤æ–­è§£æçš„ç»“æœæ˜¯ä¸æ˜¯ä¸€ä¸ªé”™è¯¯å¯¹è±¡ï¼Œå¦‚æœæ˜¯é”™è¯¯å¯¹è±¡åˆ™è°ƒç”¨ <code>socketOnError()</code>ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">socketOnError</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Ignore further errors</span></span><br><span class="line">  <span class="built_in">this</span>.removeListener(<span class="string">&#x27;error&#x27;</span>, socketOnError);</span><br><span class="line">  <span class="built_in">this</span>.on(<span class="string">&#x27;error&#x27;</span>, <span class="function">() =&gt;</span> &#123;&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">this</span>.server.emit(<span class="string">&#x27;clientError&#x27;</span>, e, <span class="built_in">this</span>))</span><br><span class="line">    <span class="built_in">this</span>.destroy(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çœ‹åˆ°ï¼Œå¦‚æœçœŸçš„ä¸å°å¿ƒèµ°åˆ°è¿™ä¸€æ­¥çš„è¯ï¼ŒHTTP Server å¯¹è±¡ä¼šè§¦å‘ä¸€ä¸ª <code>clientError</code> äº‹ä»¶ã€‚</p>
<p>æ•´ä¸ªäº‹æƒ…ä¸²è”èµ·æ¥äº†ï¼š</p>
<ul>
<li>æ”¶åˆ°è¯·æ±‚åä¼šé€šè¿‡ http-parser è§£ææ•°æ®åŒ…ï¼›</li>
<li><code>GET /foo bar HTTP/1.1</code> ä¼šè¢«è§£æå‡ºé”™å¹¶è¿”å›ä¸€ä¸ªé”™è¯¯å¯¹è±¡ï¼›</li>
<li>é”™è¯¯å¯¹è±¡ä¼šè¿›å…¥ <code>if (ret instanceof Error)</code> æ¡ä»¶åˆ†æ”¯å¹¶è°ƒç”¨ <code>socketOnError()</code> å‡½æ•°ï¼›</li>
<li><code>socketOnError()</code> å‡½æ•°ä¸­ä¼šå¯¹æœåŠ¡å™¨è§¦å‘ä¸€ä¸ª <code>clientError</code> äº‹ä»¶ï¼›ï¼ˆ<code>this.server.emit(&#39;clientError&#39;, e, this)</code>ï¼‰</li>
<li><strong>è‡³æ­¤ï¼ŒHTTP Server å¹¶ä¸ä¼šèµ°åˆ°ä½ çš„é‚£ä¸ª <code>function(req, resp)</code> ä¸­å»ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰ä»»ä½•çš„æ•°æ®è¢«è¿”å›å°±ç»“æŸäº†ï¼Œä¹Ÿå°±è§£ç­”äº†ä¸€å¼€å§‹çš„é—®é¢˜â€”â€”æ”¶ä¸åˆ°ä»»ä½•æ•°æ®å°±è¯·æ±‚ç»“æŸã€‚</strong></li>
</ul>
<p>è¿™å°±æ˜¯æˆ‘è¦é€çº§è¿›æ¥çœ‹ä»£ç ï¼Œè€Œä¸æ˜¯ç›´è¾¾ http-parser çš„åŸå› äº†â€”â€”<code>clientError</code> æ˜¯ä¸€ä¸ªå…³é”®ã€‚</p>
<h2 id="å¤„ç†åŠæ³•"><a href="#å¤„ç†åŠæ³•" class="headerlink" title="å¤„ç†åŠæ³•"></a>å¤„ç†åŠæ³•</h2><p>è¦è§£å†³è¿™ä¸ªâ€œBugâ€å…¶å®ä¸éš¾ï¼Œç›´æ¥ç›‘å¬ <a target="_blank" rel="noopener" href="https://nodejs.org/api/http.html#http_event_clienterror"><code>clientError</code> äº‹ä»¶</a>å¹¶åšä¸€äº›å¤„ç†å³å¯ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, resp</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;ğŸŒš&#x27;</span>);</span><br><span class="line">    resp.end(<span class="string">&#x27;hello world&#x27;</span>);</span><br><span class="line">&#125;).on(<span class="string">&#x27;clientError&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, sock</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;ğŸ·&#x27;</span>);</span><br><span class="line">    sock.end(<span class="string">&#x27;HTTP/1.1 400 Bad Request\r\n\r\n&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">5555</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong>ç”±äºè¿è¡Œåˆ° <code>clientError</code> äº‹ä»¶æ—¶ï¼Œå¹¶æ²¡æœ‰ä»»ä½• Request å’Œ Response çš„å°è£…ï¼Œä½ èƒ½æ‹¿åˆ°çš„æ˜¯ä¸€ä¸ª Node.js ä¸­åŸå§‹çš„ Socket å¯¹è±¡ï¼Œæ‰€ä»¥å½“ä½ è¦è¿”å›æ•°æ®çš„æ—¶å€™éœ€è¦è‡ªå·±æŒ‰ç…§ HTTP è¿”å›æ•°æ®åŒ…çš„æ ¼å¼æ¥è¾“å‡ºã€‚</p>
</blockquote>
<p>è¿™ä¸ªæ—¶å€™å†æŒ¥èµ·ä½ çš„å°æ‰‹è¯•ä¸€ä¸‹ CURL å§ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ curl &#39;http:&#x2F;&#x2F;127.0.0.1:5555&#x2F;d d&#39; -v</span><br><span class="line">*   Trying 127.0.0.1...</span><br><span class="line">* TCP_NODELAY set</span><br><span class="line">* Connected to 127.0.0.1 (127.0.0.1) port 5555 (#0)</span><br><span class="line">&gt; GET &#x2F;d d HTTP&#x2F;1.1</span><br><span class="line">&gt; Host: 127.0.0.1:5555</span><br><span class="line">&gt; User-Agent: curl&#x2F;7.54.0</span><br><span class="line">&gt; Accept: *&#x2F;*</span><br><span class="line">&gt;</span><br><span class="line">&lt; HTTP&#x2F;1.1 400 Bad Request</span><br><span class="line">* no chunk, no close, no size. Assume close to signal end</span><br><span class="line">&lt;</span><br><span class="line">* Closing connection 0</span><br></pre></td></tr></table></figure>
<p>å¦‚æ„¿ä»¥å¿åœ°è¾“å‡ºäº† 400 çŠ¶æ€ç ã€‚</p>
<h2 id="å¼•ç”³"><a href="#å¼•ç”³" class="headerlink" title="å¼•ç”³"></a>å¼•ç”³</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¦å¼•ç”³è®¨è®ºçš„ä¸€ä¸ªç‚¹æ˜¯ï¼Œä¸ºä»€ä¹ˆè¿™è´§ä¸æ˜¯ä¸€ä¸ªçœŸæ­£æ„ä¹‰ä¸Šçš„ Bugã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬çœ‹çœ‹ Nginx è¿™ä¹ˆå®ç°è¿™ä¸ªé»‘ç§‘æŠ€çš„å§ã€‚</p>
<h3 id="Nginx-å®ç°"><a href="#Nginx-å®ç°" class="headerlink" title="Nginx å®ç°"></a>Nginx å®ç°</h3><p>æ‰“å¼€ Nginx æºç çš„<a target="_blank" rel="noopener" href="https://github.com/nginx/nginx/blob/release-1.13.7/src/http/ngx_http_parse.c#L104">ç›¸åº”ä½ç½®</a>ã€‚</p>
<p>æˆ‘ä»¬èƒ½çœ‹åˆ°å®ƒçš„çŠ¶æ€æœºå¯¹äº URI å’Œ HTTP åè®®å£°æ˜ä¸­é—´å¤šäº†ä¸€ä¸ªä¸­é—´çŠ¶æ€ï¼Œå« <code>sw_check_uri_http_09</code>ï¼Œä¸“é—¨å¤„ç† URI åé¢çš„ç©ºæ ¼ã€‚</p>
<p>åœ¨å„ç§ URI è§£æçŠ¶æ€ä¸­ï¼ŒåŸºæœ¬ä¸Šéƒ½èƒ½æ‰¾åˆ°è¿™ä¹ˆä¸€å¥è¯ï¼Œè¡¨ç¤ºè‹¥å½“å‰çŠ¶æ€æ­£åˆ™è§£æ URI çš„å„ç§çŠ¶æ€å¹¶ä¸”é‡åˆ°ç©ºæ ¼çš„è¯ï¼Œåˆ™å°†çŠ¶æ€æ”¹ä¸º <code>sw_check_uri_http_09</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> sw_check_uri:</span><br><span class="line">  <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&#x27; &#x27;</span>:</span><br><span class="line">    r-&gt;uri_end = p;</span><br><span class="line">    state = sw_check_uri_http_09;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨ <code>sw_check_uri_http_09</code> çŠ¶æ€æ—¶ä¼šåšä¸€äº›æ£€æŸ¥ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> sw_check_uri_http_09:</span><br><span class="line">    <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27; &#x27;</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> CR:</span><br><span class="line">        r-&gt;http_minor = <span class="number">9</span>;</span><br><span class="line">        state = sw_almost_done;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> LF:</span><br><span class="line">        r-&gt;http_minor = <span class="number">9</span>;</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;H&#x27;</span>:</span><br><span class="line">        r-&gt;http_protocol.data = p;</span><br><span class="line">        state = sw_http_H;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        r-&gt;space_in_uri = <span class="number">1</span>;</span><br><span class="line">        state = sw_check_uri;</span><br><span class="line">        p--;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>ä¾‹å¦‚ï¼š</p>
<ul>
<li>é‡åˆ°ç©ºæ ¼åˆ™ç»§ç»­ä¿æŒå½“å‰çŠ¶æ€å¼€å§‹æ‰«æä¸‹ä¸€ä½ï¼›</li>
<li>å¦‚æœæ˜¯æ¢è¡Œç¬¦åˆ™è®¾ç½®é»˜è®¤ HTTP ç‰ˆæœ¬å¹¶ç»§ç»­æ‰«æï¼›</li>
<li>å¦‚æœé‡åˆ°çš„æ˜¯ <code>H</code> æ‰ä¿®æ”¹çŠ¶æ€ä¸º <code>sw_http_H</code> è®¤ä¸ºæ¥ä¸‹å»å¼€å§‹ HTTP ç‰ˆæœ¬æ‰«æï¼›</li>
<li>å¦‚æœæ˜¯å…¶å®ƒå­—ç¬¦ï¼Œåˆ™æ ‡æ˜ä¸€ä¸‹ URI ä¸­æœ‰ç©ºæ ¼ï¼Œç„¶åå°†çŠ¶æ€æ”¹å› <code>sw_check_uri</code>ï¼Œç„¶åå€’é€€å›ä¸€æ ¼ä»¥ <code>sw_check_uri</code> ç»§ç»­æ‰«æå½“å‰çš„ç©ºæ ¼ã€‚</li>
</ul>
<p>åœ¨ç†è§£äº†è¿™ä¸ªâ€œé»‘ç§‘æŠ€â€åï¼Œæˆ‘ä»¬å¾ˆå¿«èƒ½æ‰¾åˆ°ä¸€ä¸ªå¾ˆå¥½ç©çš„ç‚¹ï¼Œå¼€å¯ä½ çš„ Nginx å¹¶ç”¨ CURL è¯·æ±‚ä»¥ä¸‹é¢çš„ä¾‹å­ä¸€ä¸‹å®ƒçœ‹çœ‹å§ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ curl &#39;http:&#x2F;&#x2F;xcoder.in:5555&#x2F;d H&#39; -v</span><br><span class="line">*   Trying 103.238.225.181...</span><br><span class="line">* TCP_NODELAY set</span><br><span class="line">* Connected to xcoder.in (103.238.225.181) port 5555 (#0)</span><br><span class="line">&gt; GET &#x2F;d H HTTP&#x2F;1.1</span><br><span class="line">&gt; Host: xcoder.in:5555</span><br><span class="line">&gt; User-Agent: curl&#x2F;7.54.0</span><br><span class="line">&gt; Accept: *&#x2F;*</span><br><span class="line">&gt;</span><br><span class="line">&lt; HTTP&#x2F;1.1 400 Bad Request</span><br><span class="line">&lt; Server: openresty&#x2F;1.11.2.1</span><br><span class="line">&lt; Date: Tue, 12 Dec 2017 11:18:13 GMT</span><br><span class="line">&lt; Content-Type: text&#x2F;html</span><br><span class="line">&lt; Content-Length: 179</span><br><span class="line">&lt; Connection: close</span><br><span class="line">&lt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;400 Bad Request&lt;&#x2F;title&gt;&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body bgcolor&#x3D;&quot;white&quot;&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;400 Bad Request&lt;&#x2F;h1&gt;&lt;&#x2F;center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;openresty&#x2F;1.11.2.1&lt;&#x2F;center&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line">* Closing connection 0</span><br></pre></td></tr></table></figure>
<p>æ€ä¹ˆæ ·ï¼Ÿæ˜¯ä¸æ˜¯å‘ç°ç»“æœè·Ÿä¹‹å‰çš„ä¸ä¸€æ ·äº†â€”â€”å®ƒå±…ç„¶ä¹Ÿè¿”å›äº† 400 Bad Requestã€‚</p>
<p>åŸå› ä¸ºä½•å°±äº¤ç»™ç«¥é‹ä»¬è‡ªå·±è€ƒè™‘å§ã€‚</p>
<h3 id="RFC-2616-ä¸-RFC-2396"><a href="#RFC-2616-ä¸-RFC-2396" class="headerlink" title="RFC 2616 ä¸ RFC 2396"></a>RFC 2616 ä¸ RFC 2396</h3><p>é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆå³ä½¿åœ¨ Nginx æ”¯æŒç©ºæ ¼ URI çš„æƒ…å†µä¸‹ï¼Œæˆ‘è¿˜è¯´ Node.js è¿™ä¸ªä¸ç®— Bugï¼Œå¹¶ä¸”æŒ‡æ˜ Nginx æ˜¯â€œé»‘ç§‘æŠ€â€å‘¢ï¼Ÿ</p>
<p>åæ¥æˆ‘å»çœ‹äº† HTTP åè®® RFCã€‚</p>
<p>åŸå› åœ¨äº Network Working Group çš„ <a target="_blank" rel="noopener" href="http://www.ietf.org/rfc/rfc2616.txt">RFC 2616</a>ï¼Œå…³äº HTTP åè®®çš„è§„èŒƒã€‚</p>
<p>åœ¨ RFC 2616 çš„ <a target="_blank" rel="noopener" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec3.html#sec3.2.1">3.2.1 èŠ‚</a>ä¸­åšäº†ä¸€äº›è¯´æ˜ï¼Œå®ƒè¯´äº†åœ¨ HTTP åè®®ä¸­å…³äº URI çš„æ–‡æ³•å’Œè¯­ä¹‰å‚ç…§äº† <a target="_blank" rel="noopener" href="http://www.ietf.org/rfc/rfc2396.txt">RFC 2396</a>ã€‚</p>
<blockquote>
<p>URIs in HTTP can be represented in absolute form or relative to some known base URI, depending upon the context of their use. The two forms are differentiated by the fact that absolute URIs always begin with a scheme name followed by a colon. For definitive information on URL syntax and semantics, see â€œUniform Resource Identifiers (URI): Generic Syntax and Semantics,â€ RFC 2396 (which replaces RFCs 1738 and RFC 1808). This specification adopts the definitions of â€œURI-referenceâ€, â€œabsoluteURIâ€, â€œrelativeURIâ€, â€œportâ€, â€œhostâ€,â€abs_pathâ€, â€œrel_pathâ€, and â€œauthorityâ€ from that specification.</p>
</blockquote>
<p>è€Œåœ¨ <a target="_blank" rel="noopener" href="http://www.ietf.org/rfc/rfc2396.txt">RFC 2396</a> ä¸­ï¼Œæˆ‘ä»¬åŒæ ·æ‰¾åˆ°äº†å®ƒçš„ <a target="_blank" rel="noopener" href="http://www.ietf.org/rfc/rfc2396.txt">2.4.3 èŠ‚</a>ã€‚é‡Œé¢å¯¹äº Disallow çš„ US-ASCII å­—ç¬¦åšäº†è§£é‡Šï¼Œå…¶ä¸­æœ‰ï¼š</p>
<ul>
<li><p>æ§åˆ¶ç¬¦ï¼ŒæŒ‡ ASCII ç åœ¨ 0x00-0x1F èŒƒå›´å†…ä»¥åŠ 0x7Fï¼›</p>
<p>  æ§åˆ¶ç¬¦é€šå¸¸ä¸å¯è§ï¼›</p>
</li>
<li><p>ç©ºæ ¼ï¼ŒæŒ‡ 0x20ï¼›</p>
<p>  ç©ºæ ¼ä¸å¯æ§ï¼Œå¦‚ç»ç”±ä¸€äº›æ’ç‰ˆè½¯ä»¶è½¬å½•åå¯èƒ½ä¼šæœ‰å˜åŒ–ï¼Œ<span style="color: #ccc;">è€Œåˆ°äº† HTTP åè®®è¿™å±‚æ—¶ï¼Œåæ­£ç©ºæ ¼ä¸æ¨èä½¿ç”¨äº†ï¼Œæ‰€ä»¥å°±ç´¢æ€§ç”¨ç©ºæ ¼ä½œä¸ºé¦–è¡Œåˆ†éš”ç¬¦äº†ï¼›</span></p>
</li>
<li><p>åˆ†éš”ç¬¦ï¼Œ<code>&quot;&lt;&quot;</code>ã€<code>&quot;&gt;&quot;</code>ã€<code>&quot;#&quot;</code>ã€<code>&quot;%&quot;</code>ã€<code>&quot;\&quot;&quot;</code>ã€‚</p>
<p>  å¦‚ <code>#</code> å°†ç”¨äºæµè§ˆå™¨åœ°å€æ çš„ Hashï¼›è€Œ <code>%</code> åˆ™ä¼šä¸ URI è½¬ä¹‰ä¸€åŒä½¿ç”¨ï¼Œæ‰€ä»¥ä¸åº”å•ç‹¬å‡ºç°åœ¨ URI ä¸­ã€‚</p>
</li>
</ul>
<p><strong>äºæ˜¯ä¹ï¼ŒHTTP è¯·æ±‚ä¸­ï¼ŒåŒ…ä½“çš„ URI ä¼¼ä¹æœ¬å°±ä¸åº”è¯¥å‡ºç°ç©ºæ ¼ï¼Œè€Œ Nginx æ˜¯ä¸€ä¸ªé»‘é­”æ³•çš„å§¿åŠ¿ã€‚</strong></p>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>åš¯ï¼Œå†™å¾—ç´¯æ­»äº†ã€‚æœ¬æ¬¡çš„ä¸€ä¸ªæ¢ç´¢åŸºäºäº†ä¸€ä¸ªæœ‰ç©ºæ ¼éæ­£å¸¸çš„ URI é€šè¿‡ CURL æˆ–è€…å…¶å®ƒä¸€äº›å®¢æˆ·ç«¯è¯·æ±‚æ—¶ï¼ŒNode.js å‡ºç°çš„ Bug çŠ¶æ€ã€‚</p>
<blockquote>
<p>å®é™…ä¸Šå‘ç°è¿™ä¸ª Bug çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯è¯·æ±‚ä¼¼ä¹æ˜¯å› ä¸ºé‚£è¾¹çš„å¼€å‘è€…æ‰‹æŠ–ï¼Œä¸å°å¿ƒå°†ä¸åº”è¯¥æ‹¼æ¥è¿›æ¥çš„å†…å®¹ç»™æ‹¼æ¥åˆ°äº† URL ä¸­ï¼Œç±»ä¼¼äº <code>$ rm -rf /</code>ã€‚</p>
</blockquote>
<p>ä¸€å¼€å§‹æˆ‘ä»¥ä¸ºè¿™æ˜¯ Node.js çš„ Bugï¼Œåœ¨æ¢å¯»ä¹‹åå‘ç°æ˜¯å› ä¸ºæˆ‘ä»¬è‡ªå·±æ²¡ç”¨ Node.js HTTP Server æä¾›çš„ <code>clientError</code> äº‹ä»¶åšæ­£ç¡®çš„å¤„ç†ã€‚è€Œ Nginx çš„æ­£å¸¸è¯·æ±‚åˆ™æ˜¯å®ƒçš„é»‘ç§‘æŠ€ã€‚è¿™äº›ç­”æ¡ˆéƒ½èƒ½ä» RFC ä¸­å¯»æ‰¾â€”â€”<strong>å†æ¬¡ä½“ç°äº†é‡åˆ°é—®é¢˜çœ‹æºç çœ‹è§„èŒƒçš„é‡è¦æ€§ã€‚</strong></p>
<p>å¦ï¼Œæˆ‘æœ¬æ‰“ç®—ç»™ http-parser ä¹ŸåŠ ä¸Šé»‘é­”æ³•ï¼Œåæ¥æˆ‘å¿«å†™å¥½çš„æ—¶å€™å‘ç°å®ƒæ˜¯æµå¼çš„ï¼Œå¾ˆå¤šçŠ¶æ€æ²¡æ³•åœ¨ç°æœ‰çš„ä½“ç³»ä¸­ä¿ç•™ä¸‹æ¥ï¼Œæœ€åæ”¾å¼ƒäº†ï¼Œåæ­£è¿™ä¹Ÿä¸ç®— Bugã€‚ä¸è¿‡åœ¨ä»¥åæœ‰æ—¶é—´çš„æ—¶å€™ï¼Œæ„Ÿè§‰è¿˜æ˜¯å¯ä»¥å¥½å¥½æ•´ç†ä¸€ä¸‹ä»£ç ï¼Œå¥½å¥½ä¿®æ”¹ä¸€ä¸‹ç»™æä¸ª PR ä¸Šå»ï¼Œä»¥æ­¤è‡ªå‹‰ã€‚</p>
<p>æœ€åï¼Œæ±‚ fafaã€‚</p>
<center><img src="http://ww2.sinaimg.cn/bmiddle/a15b4afely1fme81d41wpg206o06oabl" /></center>
<hr><section class="comment"><div id="disqus_thread"></div></section><script>var DISQUS_PAGE_URL = "https://xcoder.in/2017/12/13/node-http-parser-spaces-in-url/";</script><script>var DISQUS_IDENTIFIER = "2017/12/13/node-http-parser-spaces-in-url/";</script><script>var DISQUS_SHORT_NAME = "xcoder"</script><script>var disqus_config = function() {
  this.page.url = DISQUS_PAGE_URL;
  this.page.identifier = DISQUS_IDENTIFIER;
};

(function() {
  var d = document, s = d.createElement("script");
  s.src = "https://" + DISQUS_SHORT_NAME + ".disqus.com/embed.js";
  s.setAttribute("data-timestamp", +new Date());
  (d.head || d.body).appendChild(s);
})();</script><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><footer><section class="copyright">&copy; 2016 - 2021<a href="/">æ­»æœˆÂ·åƒåœ¡è•¾ç‰¹</a></section><section class="intro">ç”±<a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>é©±åŠ¨&middot;æŒ‚è½½<a target="_blank" rel="noopener" href="https://github.com/xadillax/hexo-xnew">X'new</a>ä¸»é¢˜</section></footer></article></main><script src="//cdn.bootcss.com/Han/3.3.0/han.min.js"></script><script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><script src="//cdn.bootcss.com/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script><script src="/scripts/highlight.pack.js"></script><script>$(function() {
    $("header").backstretch("/images/header.jpeg");

    $("figure.highlight").each(function(i, block) {
        $(block).removeClass("highlight");
        $(block).find("td.gutter").remove();
        $("<pre><code class='__tobehl " + ($(block).attr("class") === "plain" ? "" : ("lang-" + $(block).attr("class"))) + "'></code></pre>").insertAfter($(block));
        $(block).next().find("code").text((block.innerText || block.textContent));
        $(block).remove();
    });
    $(".__tobehl").each(function(i, block) {
        hljs.highlightBlock(block);
    });

    $("article.full img").each(function() {
        if($(this).parent().is("article")) {
            $(this).wrap("<p style='text-align: center;'></p>");
        } else {
            $(this).parent().css("text-align", "center");
        }
    });

    if($(".article-toc").children().length < 2) {
        $(".article-toc").css("display", "none");
    }
});</script></body></html>